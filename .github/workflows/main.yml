# Enhanced workflow for building kernel and rootfs with multi-distro support

name: Build Raphael RootFS

permissions:
  contents: write

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version and release tag (e.g., 6.18)'
        required: true
        type: string
        default: '6.18'
      distribution:
        description: 'Distribution to build (ubuntu/armbian)'
        required: true
        default: 'ubuntu'
        type: choice
        options:
          - ubuntu
          - armbian
      version:
        description: 'Distribution version'
        required: true
        default: 'noble'
        type: choice
        options:
          - noble
          - jammy
          - focal
      kernel_source:
        description: 'Source of kernel packages (release/artifacts)'
        required: true
        type: choice
        options:
          - release
          - artifacts
        default: release
      desktop_environment:
        description: 'Desktop environment to install (only for ubuntu)'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - xfce
          - gnome
          - kde

env:
  KERNEL_VERSION: ${{ github.event.inputs.kernel_version }}
  DISTRIBUTION: ${{ github.event.inputs.distribution }}
  KERNEL_SOURCE: ${{ github.event.inputs.kernel_source }}
  RELEASE_TAG: v${{ github.event.inputs.kernel_version }}
  DESKTOP_ENVIRONMENT: ${{ github.event.inputs.desktop_environment }}

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # Build root filesystem
  rootfs:
    name: Build RootFS
    runs-on: ubuntu-24.04-arm  
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment variables
      run: |
        echo "Building rootfs for distribution: $DISTRIBUTION"
        echo "Kernel version: $KERNEL_VERSION"
        echo "Kernel source: $KERNEL_SOURCE"
        echo "Release tag: $RELEASE_TAG"
        echo "Desktop environment: $DESKTOP_ENVIRONMENT"
        
    - name: Setup inputs
      run: |
        echo "üöÄ Starting rootfs build"
        echo "üì¶ Distribution: $DISTRIBUTION"
        echo "üîß Kernel Version: $KERNEL_VERSION"
        echo "üìé Kernel Source: $KERNEL_SOURCE"
        if [[ "$KERNEL_SOURCE" == "release" ]]; then
          echo "üè∑Ô∏è  Release Tag: $RELEASE_TAG"
        fi
         
    - name: Download kernel packages from GitHub Release
      if: ${{ github.event.inputs.kernel_source == 'release' }}
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "üì• Downloading kernel packages from GitHub Release: $RELEASE_TAG"
        
        # First try to download compressed kernel archive (new format)
        echo "üîç Looking for compressed kernel archive..."
        gh release download $RELEASE_TAG \
          --pattern "kernel-${KERNEL_VERSION}-raphael.tar.gz" \
          --pattern "kernel-${KERNEL_VERSION}-raphael.zip" \
          --repo ${{ github.repository }} || echo "‚ö†Ô∏è Compressed archive not found, trying individual packages"
        
        # If compressed archive found, extract it
        if [ -f "kernel-${KERNEL_VERSION}-raphael.tar.gz" ]; then
          echo "üì¶ Extracting compressed kernel archive..."
          tar -xzf "kernel-${KERNEL_VERSION}-raphael.tar.gz"
          
          # Move packages from archive subdirectory
          if [ -d "packages" ]; then
            mv packages/*.deb . 2>/dev/null || true
            rm -rf packages
          fi
          
          echo "‚úÖ Compressed archive extracted successfully"
        elif [ -f "kernel-${KERNEL_VERSION}-raphael.zip" ]; then
          echo "üì¶ Extracting compressed kernel archive..."
          unzip -q "kernel-${KERNEL_VERSION}-raphael.zip"
          
          # Move packages from archive subdirectory
          if [ -d "packages" ]; then
            mv packages/*.deb . 2>/dev/null || true
            rm -rf packages
          fi
          
          echo "‚úÖ Compressed archive extracted successfully"
        else
          # Fallback to individual package download (old format)
          echo "üì¶ Downloading individual kernel packages..."
          gh release download $RELEASE_TAG \
            --pattern "linux-xiaomi-raphael_*.deb" \
            --pattern "firmware-xiaomi-raphael_*.deb" \
            --pattern "alsa-xiaomi-raphael_*.deb" \
            --repo ${{ github.repository }}
        fi
        
        # Verify downloaded packages
        echo "üîç Verifying downloaded kernel packages:"
        
        # Use wildcard pattern to match actual package names with full version
        REQUIRED_PACKAGES=("linux-xiaomi-raphael_*_arm64.deb" 
                          "firmware-xiaomi-raphael_*_arm64.deb"
                          "alsa-xiaomi-raphael_*_arm64.deb")
        
        for pkg_pattern in "${REQUIRED_PACKAGES[@]}"; do
          # Find the actual package file matching the pattern
          pkg_file=$(find . -name "$pkg_pattern" -type f | head -1)
          
          if [ -f "$pkg_file" ]; then
            echo "‚úÖ Found: $pkg_file"
            dpkg-deb -I "$pkg_file" || echo "‚ö†Ô∏è Package verification failed for $pkg_file"
          else
            echo "‚ùå Missing package matching pattern: $pkg_pattern"
            echo "üìÅ Available files:"
            ls -la *.deb 2>/dev/null || echo "No .deb files found"
            exit 1
          fi
        done
        
    - name: Download kernel packages from workflow artifacts
      if: ${{ github.event.inputs.kernel_source == 'artifacts' }}
      uses: actions/download-artifact@v4
      with:
        name: kernel-packages-${{ github.event.inputs.kernel_version }}
        path: ./
        
    - name: Verify kernel packages
      if: ${{ github.event.inputs.kernel_source == 'artifacts' }}
      run: |
        echo "üîç Verifying kernel packages from artifacts:"
        
        # Use wildcard pattern to match actual package names with full version
        REQUIRED_PACKAGES=("linux-xiaomi-raphael_*_arm64.deb" 
                          "firmware-xiaomi-raphael_*_arm64.deb"
                          "alsa-xiaomi-raphael_*_arm64.deb")
        
        for pkg_pattern in "${REQUIRED_PACKAGES[@]}"; do
          # Find the actual package file matching the pattern
          pkg_file=$(find . -name "$pkg_pattern" -type f | head -1)
          
          if [ -f "$pkg_file" ]; then
            echo "‚úÖ Found: $pkg_file"
            dpkg-deb -I "$pkg_file" || echo "‚ö†Ô∏è Package verification failed for $pkg_file"
          else
            echo "‚ùå Missing package matching pattern: $pkg_pattern"
            echo "üìÅ Available files:"
            ls -la *.deb 2>/dev/null || echo "No .deb files found"
            exit 1
          fi
        done

    - name: Cache rootfs build
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache
          ~/.cache/debootstrap
          ~/.cache/apt-cacher-ng
          rootfs-build/
          /var/cache/apt
          /var/lib/apt
          ${{ github.workspace }}/kernel-packages
        key: ${{ runner.os }}-rootfs-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}-${{ hashFiles('raphael-rootfs_build.sh', 'build-config.sh') }}
        restore-keys: |
          ${{ runner.os }}-rootfs-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}
          ${{ runner.os }}-rootfs-${{ github.event.inputs.distribution }}
          ${{ runner.os }}-rootfs-

    - name: Install Dependencies
      run: |
         echo "üì¶ Installing rootfs build dependencies..."
         sudo apt update
         
         # Âü∫Á°Ä‰æùËµñÂåÖ
         BASE_DEPS="fakeroot cpio kmod rsync wget curl file parted dosfstools e2fsprogs util-linux systemd-container jq kpartx"
         
         # Ê†πÊçÆÊû∂ÊûÑÂÜ≥ÂÆöÊòØÂê¶ÂÆâË£ÖQEMU
         if [ "$(uname -m)" != "aarch64" ]; then
             echo "üîß Running on $(uname -m), installing QEMU for emulation..."
             sudo apt install -y qemu-user-static binfmt-support $BASE_DEPS
         else
             echo "üîß Running on ARM64, installing native dependencies..."
             sudo apt install -y binfmt-support $BASE_DEPS
         fi

    - name: Build rootfs
      run: |
         set -e  # Exit on any error
         echo "üöÄ Starting rootfs build for distribution: $DISTRIBUTION"
         echo "üì¶ Kernel version: $KERNEL_VERSION"
         echo "üñ•Ô∏è  Desktop environment: $DESKTOP_ENVIRONMENT"
         echo "üì• Kernel source: $KERNEL_SOURCE"
         
         # Set environment variables for the build script
         export KERNEL_VERSION="$KERNEL_VERSION"
         export DISTRIBUTION="$DISTRIBUTION"
         export DESKTOP_ENVIRONMENT="$DESKTOP_ENVIRONMENT"
         export KERNEL_SOURCE="$KERNEL_SOURCE"
         export GITHUB_WORKSPACE="$GITHUB_WORKSPACE"
         
         # Build rootfs with error handling
         if ! sudo bash ./raphael-rootfs_build.sh; then
           echo "‚ùå RootFS build failed!"
           exit 1
         fi
         echo "‚úÖ RootFS build completed successfully for $DISTRIBUTION"

    - name: Validate rootfs build artifacts
      run: |
         echo "üîç Validating rootfs build artifacts..."
         
         # Check if rootfs image was created
         if [ ! -f "root-*.img" ]; then
           echo "‚ùå Missing rootfs image file"
           ls -la *.img || echo "No image files found"
           exit 1
         fi
         
         # Check image file size and integrity
         ROOTFS_IMAGE=$(ls root-*.img | head -1)
         echo "üìÅ RootFS image: $ROOTFS_IMAGE"
         ls -lh "$ROOTFS_IMAGE"
         
         # Basic file validation
         if [ ! -s "$ROOTFS_IMAGE" ]; then
           echo "‚ùå RootFS image is empty or invalid"
           exit 1
         fi
         
         # Check file type
         file "$ROOTFS_IMAGE" || echo "‚ö†Ô∏è File command not available"
         
         # Enhanced validation: Check partition table
         echo "üîç Checking partition table:"
         sudo fdisk -l "$ROOTFS_IMAGE" || echo "‚ö†Ô∏è Partition table check failed"
         
         # Try to mount and verify content
         echo "üîç Verifying RootFS content..."
         sudo kpartx -a "$ROOTFS_IMAGE"
         sleep 2
         
         # Check if root partition exists
         if [ -b /dev/mapper/loop0p2 ]; then
           echo "‚úÖ Root partition found"
           
           # Mount root partition
           sudo mkdir -p /mnt/rootfs
           sudo mount /dev/mapper/loop0p2 /mnt/rootfs
           
           # Check key files
           key_files=("/mnt/rootfs/etc/hostname" "/mnt/rootfs/etc/fstab" "/mnt/rootfs/boot/vmlinuz*" "/mnt/rootfs/lib/modules")
           for file in "${key_files[@]}"; do
             if [ -e "$file" ]; then
               echo "‚úÖ Found: $file"
             else
               echo "‚ùå Missing: $file"
             fi
           done
           
           # Check kernel modules
           if ls /mnt/rootfs/lib/modules/${{ env.KERNEL_VERSION }}* 1> /dev/null 2>&1; then
             echo "‚úÖ Kernel modules installed:"
             ls -la /mnt/rootfs/lib/modules/${{ env.KERNEL_VERSION }}*
           else
             echo "‚ùå Kernel modules not found"
           fi
           
           # Unmount and cleanup
           sudo umount /mnt/rootfs
           sudo rmdir /mnt/rootfs
         else
           echo "‚ö†Ô∏è Could not find root partition"
         fi
         
         # Cleanup loop devices
         sudo kpartx -d "$ROOTFS_IMAGE"
         
         echo "‚úÖ RootFS artifacts validated successfully"

    - name: Compress rootfs image to zip
      run: |
         echo "üóúÔ∏è Compressing rootfs image to zip..."
         ROOTFS_IMAGE=$(ls root-*.img | head -1)
         ZIP_NAME="${ROOTFS_IMAGE%.img}.zip"
         
         # ÂéãÁº©ÈïúÂÉèÊñá‰ª∂
         zip -9 "$ZIP_NAME" "$ROOTFS_IMAGE"
         
         echo "‚úÖ Compressed: $ZIP_NAME"
         ls -lh "$ZIP_NAME"
         
    - name: Upload rootfs image and zip
      uses: actions/upload-artifact@v4
      with:
         name: xiaomi-raphael-rootfs_${{ github.event.inputs.distribution }}_${{ github.event.inputs.kernel_version }}
         path: |
           root-*.img
           root-*.zip
         retention-days: 30

  release:
     name: Create Release
     runs-on: ubuntu-24.04-arm
     needs: [rootfs]
     if: github.event.inputs.release_tag != ''
     
     steps:
     - name: Checkout repository
       uses: actions/checkout@v4
       
     - name: Download rootfs artifact
       uses: actions/download-artifact@v4
       with:
         name: xiaomi-raphael-rootfs_${{ github.event.inputs.distribution }}_${{ github.event.inputs.kernel_version }}
         path: ./rootfs-images
         
     - name: Create release
       uses: softprops/action-gh-release@v1
       with:
        tag_name: ${{ github.event.inputs.release_tag }}
        name: "Raphael ${{ github.event.inputs.distribution }} ${{ github.event.inputs.kernel_version }}"
        body: |
          # Raphael ${{ github.event.inputs.distribution }} ${{ github.event.inputs.kernel_version }}
          
          ## RootFS Images
          - **Full Image**: root-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}.img
          - **Compressed**: root-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}.zip (recommended for boot image builds)
          
          ## Build Information
          - Distribution: ${{ github.event.inputs.distribution }}
          - Kernel Version: ${{ github.event.inputs.kernel_version }}
          - Desktop Environment: ${{ github.event.inputs.desktop_environment }}
          - Architecture: ARM64
          - Target Device: Xiaomi Raphael (K20 Pro)
          - Build Date: ${{ github.event.repository.created_at }}
          - Build ID: ${{ github.run_id }}
          
          ## Usage
          
          ### Flashing Instructions:
          ```bash
          # Unzip the RootFS
          unzip root-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}.zip
          
          # Flash to your device (adjust for your setup)
          fastboot flash system root-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}.img
          ```
          
          ## Usage Notes
          - For boot image creation, download the .zip file for faster transfer
          - Extract the .img file from the .zip before use
          
          ## Changelog
          - Kernel version: ${{ github.event.inputs.kernel_version }}
          - Distribution: ${{ github.event.inputs.distribution }}
          - Desktop Environment: ${{ github.event.inputs.desktop_environment }}
          
        files: |
          rootfs-images/*.img
          rootfs-images/*.zip
        draft: false
        prerelease: false