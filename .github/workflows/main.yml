# Enhanced workflow for building kernel and rootfs with multi-distro support

name: Raphael Multi-Distro Kernel and RootFS Builder

permissions:
  contents: write

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version to build (e.g., 6.17)'
        required: true
        default: '6.17'
        type: string
      distribution:
        description: 'Distribution to build'
        required: true
        default: 'ubuntu'
        type: choice
        options:
          - ubuntu
          - armbian
      version:
        description: 'Distribution version'
        required: true
        default: 'noble'
        type: choice
        options:
          - noble
          - jammy
          - focal
      desktop_environment:
        description: 'Desktop environment or server (for Ubuntu only)'
        required: false
        default: 'ubuntu-desktop'
        type: choice
        options:
          - ubuntu-desktop
          - ubuntu-server
          - kubuntu-desktop
          - xubuntu-desktop
          - lubuntu-desktop
          - ubuntu-mate
          - gnome
          - kde
          - xfce
          - lxde
          - mate
          - server
      release_tag:
        description: 'Release tag version'
        required: true
        default: 'v1.0.0'
        type: string

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  kernel:
    runs-on: ubuntu-latest
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 5G
      ARCH: arm64
    
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
        
      - name: Cache build dependencies
        uses: actions/cache@v3
        id: cache-deps
        with:
          path: |
            ~/.cache/apt
            /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('**/raphael-kernel_build.sh', '**/raphael-rootfs_build.sh') }}
          restore-keys: |
            ${{ runner.os }}-apt-
            
      - name: Cache kernel build
        uses: actions/cache@v3
        id: cache-kernel
        with:
          path: |
            kernel-cache/
            linux-*/
            .ccache/
          key: ${{ runner.os }}-kernel-${{ github.event.inputs.kernel_version }}-${{ hashFiles('**/raphael-kernel_build.sh', '**/DEBIAN/control') }}
          restore-keys: |
            ${{ runner.os }}-kernel-${{ github.event.inputs.kernel_version }}-
            ${{ runner.os }}-kernel-

      - name: Check Environment
        run: |
          echo "? Checking build environment..."
          echo "? Kernel version: ${{ github.event.inputs.kernel_version }}"
          echo "? Runner OS: ${{ runner.os }}"
          echo "?? Architecture: ${{ env.ARCH }}"
          
          # Check required tools
          echo "? Required tools check:" 
          which gcc && echo "  - GCC ?" || { echo "? GCC not found"; exit 1; }
          which make && echo "  - Make ?" || { echo "? Make not found"; exit 1; }
          which git && echo "  - Git ?" || { echo "? Git not found"; exit 1; }
          # Make aarch64-linux-gnu-gcc check non-fatal to allow fallback to auto-install
          which aarch64-linux-gnu-gcc && echo "  - aarch64-linux-gnu-gcc ?" || echo "?? aarch64-linux-gnu-gcc not found, will attempt to install during build"
          
          # Check disk space with threshold verification
          echo "? Disk space check:"
          df -h | grep /dev/ || true
          
          # Check available disk space
          AVAILABLE_SPACE=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          REQUIRED_SPACE=10
          
          if [ "$AVAILABLE_SPACE" -lt "$REQUIRED_SPACE" ]; then
            echo "? Insufficient disk space: $AVAILABLE_SPACE GB available, $REQUIRED_SPACE GB required"
            exit 1
          else
            echo "? Sufficient disk space: $AVAILABLE_SPACE GB available"
          fi
          
          # Check memory
          echo "? Memory status:"
          free -h
          
      - name: Install Dependencies
        run: |
          echo "? Installing build dependencies..."
          sudo apt update
          # Install dependencies without specific version pinning to ensure compatibility
          sudo apt install -y \
            build-essential \
            gcc-aarch64-linux-gnu \
            bc \
            flex \
            bison \
            p7zip-full \
            kmod \
            bash \
            cpio \
            binutils \
            tar \
            git \
            wget \
            dpkg \
            libssl-dev \
            ccache

      - name: Configure ccache
        run: |
          mkdir -p ${{ env.CCACHE_DIR }}
          echo "max_size = ${{ env.CCACHE_MAXSIZE }}" > ${{ env.CCACHE_DIR }}/ccache.conf || true
          mkdir -p ${{ env.CCACHE_DIR }}/bin
          for c in aarch64-linux-gnu-gcc aarch64-linux-gnu-g++ arm-linux-gnueabi-gcc arm-linux-gnueabi-g++; do
            ln -sf $(which ccache) ${{ env.CCACHE_DIR }}/bin/$c || true
          done
          sudo chmod -R 777 ${{ env.CCACHE_DIR }}

      - name: Restore ccache
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: kernel-ccache-${{ runner.os }}-${{ env.ARCH }}-${{ github.event.inputs.kernel_version }}-${{ hashFiles('**/raphael-kernel_build.sh') }}
          restore-keys: |
            kernel-ccache-${{ runner.os }}-${{ env.ARCH }}-${{ github.event.inputs.kernel_version }}-
            kernel-ccache-${{ runner.os }}-${{ env.ARCH }}-

      - name: Build kernel
        run: |
          set -e  # Exit on any error
          echo "? Starting kernel build for version: ${{ github.event.inputs.kernel_version }}"
          echo "? Distribution: ${{ github.event.inputs.distribution }}"
          
          # Prepend ccache wrapper bin directory so cross-compilers are invoked via ccache
          export PATH="${{ github.workspace }}/.ccache/bin:$PATH"
          # Set GITHUB_WORKSPACE for script use
          export GITHUB_WORKSPACE=${{ github.workspace }}
          ccache -z || echo "?? ccache reset failed, continuing..."
          
          # Build kernel with error handling
          if ! bash ./raphael-kernel_build.sh ${{ github.event.inputs.kernel_version }} ${{ github.event.inputs.distribution }}; then
            echo "? Kernel build failed!"
            exit 1
          fi
          echo "? Kernel build completed successfully for ${{ github.event.inputs.distribution }}"

      - name: Validate kernel build artifacts
        run: |
          echo "? Validating kernel build artifacts..."
          
          # Check if DEB files were created
          if [ ! -f "linux-xiaomi-raphael.deb" ]; then
            echo "? Missing kernel DEB package: linux-xiaomi-raphael.deb"
            ls -la *.deb || echo "No DEB files found"
            exit 1
          fi
          
          # Check if firmware DEB exists
          if [ ! -f "firmware-xiaomi-raphael.deb" ]; then
            echo "? Missing firmware DEB package: firmware-xiaomi-raphael.deb"
            exit 1
          fi
          
          # Check if ALSA DEB exists
          if [ ! -f "alsa-xiaomi-raphael.deb" ]; then
            echo "? Missing ALSA DEB package: alsa-xiaomi-raphael.deb"
            exit 1
          fi
          
          echo "? All kernel artifacts validated successfully"

      - name: Collect built DEB files
        run: |
          echo "? Collecting built DEB files..."
          mkdir -p kernel-debs
          mv *.deb kernel-debs/ || { echo "? Failed to move DEB files"; exit 1; }
          
          echo "? Collected DEB packages:"
          ls -la kernel-debs/
          
          # Verify all packages are present
          expected_packages=("linux-xiaomi-raphael.deb" "firmware-xiaomi-raphael.deb" "alsa-xiaomi-raphael.deb")
          for pkg in "${expected_packages[@]}"; do
            if [ ! -f "kernel-debs/$pkg" ]; then
              echo "? Missing expected package: $pkg"
              exit 1
            fi
          done

      - name: Show ccache stats
        if: always()
        run: |
          echo "==== ? ccache stats (before save) ===="
          ccache -s || true

      - name: Save ccache
        if: always()
        uses: actions/cache/save@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: kernel-ccache-${{ runner.os }}-${{ env.ARCH }}-${{ github.event.inputs.kernel_version }}-${{ hashFiles('**/raphael-kernel_build.sh') }}

      - name: List built DEB files
        run: ls -la *.deb || echo "No DEB files found"

      - name: Upload deb packages as artifact
        uses: actions/upload-artifact@v4
        with:
          name: xiaomi-raphael-debs_${{ github.event.inputs.kernel_version }}
          path: "kernel-debs/*.deb"
          retention-days: 1
          
  rootfs:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs: kernel
    
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
        
      - name: Download kernel artifacts
        uses: actions/download-artifact@v4
        with:
          name: xiaomi-raphael-debs_${{ github.event.inputs.kernel_version }}
          path: ./xiaomi-raphael-debs_${{ github.event.inputs.kernel_version }}

      - name: Validate downloaded artifacts
        run: |
          echo "? Validating downloaded kernel artifacts..."
          
          # Check if artifacts directory exists
          if [ ! -d "./xiaomi-raphael-debs_${{ github.event.inputs.kernel_version }}" ]; then
            echo "? Artifacts directory not found"
            exit 1
          fi
          
          # Check for required DEB files
          expected_packages=("linux-xiaomi-raphael.deb" "firmware-xiaomi-raphael.deb" "alsa-xiaomi-raphael.deb")
          for pkg in "${expected_packages[@]}"; do
            if [ ! -f "./xiaomi-raphael-debs_${{ github.event.inputs.kernel_version }}/$pkg" ]; then
              echo "? Missing required package: $pkg"
              ls -la "./xiaomi-raphael-debs_${{ github.event.inputs.kernel_version }}/" || echo "No files in artifacts directory"
              exit 1
            fi
          done
          
          echo "? All kernel artifacts downloaded and validated successfully"

      - name: List downloaded DEB files
        run: |
          echo "? Downloaded DEB packages:"
          ls -la "./xiaomi-raphael-debs_${{ github.event.inputs.kernel_version }}/" || { echo "? Failed to list artifacts"; exit 1; }

      - name: Cache rootfs dependencies and build artifacts
        uses: actions/cache@v3
        id: cache-rootfs
        with:
          path: |
            ~/.cache/apt
            /var/cache/apt/archives
            rootfs-cache/
            # Cache downloaded base system images to speed up builds
            ubuntu-base-*.tar.gz
          key: ${{ runner.os }}-rootfs-${{ github.event.inputs.desktop_environment }}-${{ github.event.inputs.kernel_version }}-${{ hashFiles('**/raphael-rootfs_build.sh') }}
          restore-keys: |
            ${{ runner.os }}-rootfs-${{ github.event.inputs.desktop_environment }}-
            ${{ runner.os }}-rootfs-

      - name: Install Dependencies
        run: |
          echo "? Installing rootfs build dependencies..."
          sudo apt update
          # Install dependencies without specific version pinning to ensure compatibility
          sudo apt install -y \
            unzip \
            build-essential \
            gcc-aarch64-linux-gnu \
            bc \
            flex \
            bison \
            p7zip-full \
            f2fs-tools \
            qemu-user-static \
            kmod \
            bash \
            cpio \
            binutils \
            tar \
            git \
            wget \
            dpkg \
            libssl-dev
          echo "? Rootfs dependencies installed successfully"

      - name: Install debootstrap for Debian support
        if: github.event.inputs.distribution == 'debian'
        run: |
          echo "? Installing debootstrap for Debian build..."
          sudo apt update
          sudo apt install -y debootstrap
          
      - name: Build rootfs
        run: |
          echo "? Starting rootfs build..."
          echo "? Distribution: ${{ github.event.inputs.distribution }}"
          echo "? Version: ${{ github.event.inputs.version }}"
          echo "?? Desktop: ${{ github.event.inputs.desktop_environment }}"
          echo "? Kernel: ${{ github.event.inputs.kernel_version }}"
          
          # Build rootfs with enhanced script
          # For Armbian, desktop_environment is not used
          if [ "${{ github.event.inputs.distribution }}" = "armbian" ]; then
            if ! sudo bash ./raphael-rootfs_build.sh ${{ github.event.inputs.distribution }} ${{ github.event.inputs.version }} ${{ github.event.inputs.kernel_version }}; then
              echo "? Armbian RootFS build failed!"
              exit 1
            fi
          else
            # For Ubuntu, pass desktop_environment as the first parameter after distribution
            if ! sudo bash ./raphael-rootfs_build.sh ${{ github.event.inputs.distribution }} ${{ github.event.inputs.version }} ${{ github.event.inputs.kernel_version }} ${{ github.event.inputs.desktop_environment }}; then
              echo "? Ubuntu RootFS build failed!"
              exit 1
            fi
          fi
          echo "? RootFS build completed successfully"

      - name: Upload rootfs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: rootfs_${{ github.event.inputs.distribution }}_${{ github.event.inputs.desktop_environment }}_${{ github.event.inputs.kernel_version }}
          path: rootfs.7z
          compression-level: 0
          retention-days: 1

  release:
    runs-on: ubuntu-latest
    needs: [kernel, rootfs]
    
    steps:
      - name: Download kernel artifacts
        uses: actions/download-artifact@v4
        with:
          name: xiaomi-raphael-debs_${{ github.event.inputs.kernel_version }}
          path: kernel-debs/
          
      - name: Download rootfs artifacts
        uses: actions/download-artifact@v4
        with:
          name: rootfs_${{ github.event.inputs.distribution }}_${{ github.event.inputs.desktop_environment }}_${{ github.event.inputs.kernel_version }}
          path: rootfs/
          
      - name: Display structure of downloaded files
        run: |
          echo "? Kernel DEBs:"
          find kernel-debs/ -type f -name "*.deb" || echo "No DEB files found"
          echo "? RootFS:"
          find rootfs/ -type f -name "*.7z" || echo "No 7z files found"
        
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: Raphael ${{ github.event.inputs.distribution }} Build ${{ github.event.inputs.release_tag }}
          body: |
            # Raphael ${{ github.event.inputs.distribution }} Build
            
            This release contains the kernel and rootfs for Xiaomi K20 Pro (Raphael).
            
            ## Build Information
            - **Distribution**: ${{ github.event.inputs.distribution }}
            - **Desktop Environment**: ${{ github.event.inputs.desktop_environment }}
            - **Kernel Version**: ${{ github.event.inputs.kernel_version }}
            - **Build Date**: ${{ github.event.inputs.release_tag }}
            - **Default User**: ubuntu (password: 1234)
            
            ## Files Included
            - `linux-xiaomi-raphael_*.deb` - Custom kernel package
            - `firmware-xiaomi-raphael_*.deb` - Device firmware
            - `alsa-xiaomi-raphael_*.deb` - Audio configuration
            - `rootfs.7z` - Root filesystem image
            
            ## Installation
            Please refer to the README for installation instructions.
          draft: false
          prerelease: false
          files: |
            kernel-debs/*.deb
            rootfs/rootfs.7z