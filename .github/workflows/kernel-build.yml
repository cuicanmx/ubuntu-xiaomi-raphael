name: Kernel Build and Release

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version (e.g., 6.18)'
        required: true
        type: string
        default: '6.18'
      upload_to_release:
        description: 'Upload kernel packages to GitHub Release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
    build-kernel:
      name: Build Kernel Packages
      runs-on: ubuntu-24.04-arm
      env:
        ARCH: arm64
      
      steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup build environment
        run: |
          echo "ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒ..."
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p ~/.ccache output/kernel
          
      - name: Install build dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–é¡¹..."
          sudo apt-get update
          sudo apt-get install -y build-essential bison flex libssl-dev bc git device-tree-compiler dpkg-dev debhelper fakeroot ccache libncurses-dev libelf-dev
          
          echo "âœ… ä¾èµ–é¡¹å®‰è£…å®Œæˆ"
            
      - name: Configure ccache
        run: |
          echo "ğŸ”§ é…ç½®ccacheç¼–è¯‘ç¼“å­˜..."
          ccache --version
          
          # è®¾ç½®ccacheç¯å¢ƒå˜é‡
          export CCACHE_DIR=~/.ccache
          export CCACHE_MAXSIZE=15G
          export CCACHE_COMPRESS=1
          export CCACHE_COMPRESSLEVEL=6
          
          mkdir -p ~/.ccache
          
          echo "ğŸ“Š åˆå§‹ccacheç»Ÿè®¡:"
          ccache -s -v
          
      - name: Restore ccache cache
        uses: actions/cache@v3
        with:
          path: ~/.ccache
          key: kernel-${{ github.event.inputs.kernel_version }}-${{ runner.os }}
          restore-keys: |
            kernel-${{ github.event.inputs.kernel_version }}-
            kernel-
              
      - name: Build kernel packages
        run: |
          echo "ğŸš€ å¼€å§‹å†…æ ¸æ„å»º..."
          chmod +x ./raphael-kernel_build.sh
          
          echo "ğŸ”§ ç³»ç»Ÿä¿¡æ¯:"
          uname -a
          echo "ğŸ”§ ç¼–è¯‘å™¨ä¿¡æ¯:"
          gcc --version | head -n1
          g++ --version | head -n1
          echo "ğŸ”§ å†…å­˜ä¿¡æ¯:"
          free -h
          echo "ğŸ”§ ç£ç›˜ç©ºé—´:"
          df -h
          
          echo "ğŸ“Š æ„å»ºå‰ccacheç»Ÿè®¡:"
          ccache -s
          
          # è®¾ç½®è¶…æ—¶å’Œé”™è¯¯å¤„ç†
          set -e
          set -o pipefail
          
          # ä½¿ç”¨è„šæœ¬çš„ç¼“å­˜æ§åˆ¶åŠŸèƒ½
          echo "ğŸ”§ æ‰§è¡Œå†…æ ¸æ„å»ºè„šæœ¬..."
          if ! ./raphael-kernel_build.sh "${{ github.event.inputs.kernel_version }}" --cache; then
              echo "âŒ å†…æ ¸æ„å»ºå¤±è´¥ï¼"
              echo "ğŸ“‹ è°ƒè¯•ä¿¡æ¯:"
              echo "- å†…æ ¸ç‰ˆæœ¬: ${{ github.event.inputs.kernel_version }}"
              echo "- å·¥ä½œç›®å½•: $(pwd)"
              echo "- è¾“å‡ºç›®å½•: output/kernel"
              ls -la output/kernel/ 2>/dev/null || echo "è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
              exit 1
          fi
          
          echo "âœ… å†…æ ¸æ„å»ºæˆåŠŸå®Œæˆï¼"
          echo "ğŸ“ æ„å»ºè¾“å‡ºæ–‡ä»¶:"
          ls -la output/kernel/
          
      - name: Verify build artifacts
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
          if [ ! -d "output/kernel" ]; then
              echo "âŒ è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
              exit 1
          fi
          
          echo "ğŸ“ æ„å»ºäº§ç‰©åˆ—è¡¨:"
          ls -la output/kernel/
          
          # æ£€æŸ¥å‹ç¼©åŒ…æ˜¯å¦å­˜åœ¨
          if ls output/kernel/kernel-*-raphael.tar.gz 1> /dev/null 2>&1; then
              echo "âœ… å†…æ ¸å‹ç¼©åŒ…å­˜åœ¨"
              tar -tzf output/kernel/kernel-*-raphael.tar.gz | head -10
          else
              echo "âŒ å†…æ ¸å‹ç¼©åŒ…ä¸å­˜åœ¨"
              exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          
      - name: Upload kernel packages to GitHub Release
        if: github.event.inputs.upload_to_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kernel-${{ github.event.inputs.kernel_version }}
          name: "ğŸ”§ å°ç±³ Raphael å†…æ ¸ ${{ github.event.inputs.kernel_version }} - ARM64åŸç”Ÿä¼˜åŒ–"
          generate_release_notes: true
          draft: false
          body: |
            ### ğŸ“Š åŸºæœ¬ä¿¡æ¯
            - **è®¾å¤‡å‹å·**: å°ç±³ Raphael (K20 Pro)
            - **å†…æ ¸ç‰ˆæœ¬**: ${{ github.event.inputs.kernel_version }}
            - **æ¶æ„å¹³å°**: ARM64 (åŸç”Ÿç¼–è¯‘)
            - **ç›®æ ‡å¹³å°**: SM8150 (éªé¾™ 855)
            - **æ„å»ºæ—¥æœŸ**: ${{ github.event.repository.created_at }}
            
            ### ğŸ”§ æ„å»ºè¯¦æƒ…
            - **æ„å»ºID**: ${{ github.run_id }}
            - **ç¼–è¯‘ç¯å¢ƒ**: ARM64åŸç”Ÿ (Ubuntu 24.04 ARM)
            - **ç¼“å­˜çŠ¶æ€**: ccacheå¯ç”¨ (15GB)
            - **æ„å»ºå·¥å…·é“¾**: GCC $(gcc --version | head -n1 | cut -d' ' -f3-)
            
            ## ğŸ—‚ï¸ æ–‡ä»¶è¯´æ˜
            
            ### ğŸ“¦ å‹ç¼©å½’æ¡£åŒ…ï¼ˆæ¨èä½¿ç”¨ï¼‰
            - **å®Œæ•´å‹ç¼©åŒ…**: kernel-${{ github.event.inputs.kernel_version }}-raphael.tar.gz
            
            ### ğŸ“ å‹ç¼©åŒ…å†…å®¹
            å‹ç¼©åŒ…åŒ…å«ä»¥ä¸‹å†…æ ¸åŒ…æ–‡ä»¶ï¼š
            - **linux-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb** - ä¸»å†…æ ¸åŒ…
            - **firmware-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb** - å›ºä»¶åŒ…
            - **alsa-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb** - éŸ³é¢‘é©±åŠ¨åŒ…
            
            ### ğŸš€ å®‰è£…è¯´æ˜
            ```bash
            # è§£å‹å¹¶å®‰è£…
            tar -xzf kernel-${{ github.event.inputs.kernel_version }}-raphael.tar.gz
            sudo dpkg -i *.deb
            ```
            
            ### âœ… æ”¯æŒè®¾å¤‡
            - Xiaomi Raphael (K20 Pro)
            
            ### ğŸ”§ æ„å»ºä¼˜åŒ–ç‰¹æ€§
            - âœ… ARM64åŸç”Ÿç¼–è¯‘ (æ— éœ€äº¤å‰ç¼–è¯‘)
            - âœ… ccacheç¼“å­˜ä¼˜åŒ– (15GB)
            - âœ… å‹ç¼©ç¼“å­˜ (èŠ‚çœå­˜å‚¨ç©ºé—´)
            - âœ… è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
            
            *ğŸ’« ç”± GitHub Actions ARM64åŸç”Ÿç¯å¢ƒè‡ªåŠ¨æ„å»ºï¼Œä¸“ä¸ºå°ç±³ Raphael è®¾å¤‡ä¼˜åŒ–*
          files: |
            output/kernel/kernel-*-raphael.tar.gz
      
      - name: Final ccache statistics
        run: |
          echo "ğŸ“Š æœ€ç»ˆccacheç»Ÿè®¡:"
          ccache -s
          echo ""
          echo "ğŸ“ˆ ç¼“å­˜å‘½ä¸­ç‡åˆ†æ:"
          ccache --show-stats

      - name: Save ccache cache
        if: always()
        uses: actions/cache/save@v3
        with:
          path: ~/.ccache
          key: kernel-${{ github.event.inputs.kernel_version }}-${{ runner.os }}
          
      - name: Build performance summary
        if: always()
        run: |
          echo "ğŸ“Š æ„å»ºæ€§èƒ½ç»Ÿè®¡:"
          echo "- å·¥ä½œæµ: ${{ github.workflow }}"
          echo "- è¿è¡ŒID: ${{ github.run_id }}"
          echo "- å¼€å§‹æ—¶é—´: ${{ github.event.repository.created_at }}"
          echo "- å†…æ ¸ç‰ˆæœ¬: ${{ github.event.inputs.kernel_version }}"
          echo "- è¿è¡Œç¯å¢ƒ: ARM64åŸç”Ÿ (Ubuntu 24.04 ARM)"
          echo ""
          echo "ğŸ”§ ç³»ç»Ÿèµ„æºä½¿ç”¨:"
          echo "- å†…å­˜ä½¿ç”¨:"
          free -h
          echo "- ç£ç›˜ç©ºé—´:"
          df -h | grep -E "(Filesystem|/dev/)"
          echo ""
          echo "ğŸ“ˆ æ„å»ºä¼˜åŒ–ç‰¹æ€§:"
          echo "- âœ… ARM64åŸç”Ÿç¼–è¯‘ (æ— éœ€äº¤å‰ç¼–è¯‘)"
          echo "- âœ… ccacheç¼“å­˜å¯ç”¨ (15GB)"
          echo "- âœ… å‹ç¼©ç¼“å­˜ (èŠ‚çœå­˜å‚¨ç©ºé—´)"
          echo "- âœ… è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯"
          echo "- âœ… æ„å»ºå¤±è´¥è‡ªåŠ¨æ¸…ç†"
          echo ""
          echo "ğŸ’« æ„å»ºå®Œæˆï¼"