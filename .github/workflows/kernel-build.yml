name: Kernel Build and Release

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version and release tag (e.g., 6.18)'
        required: true
        type: string
        default: '6.18'
      upload_to_release:
        description: 'Upload kernel packages to GitHub Release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
    build-kernel:
      name: Build Kernel Packages
      runs-on: ubuntu-latest
      env:
        CCACHE_DIR: ${{ github.workspace }}/.ccache
        CCACHE_MAXSIZE: 5G
        CCACHE_COMPILERCHECK: content
        CCACHE_COMPRESS: true
        CCACHE_SLOPPINESS: file_macro,locale,time_stamp
        ARCH: arm64
      
      steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install build dependencies
        run: |
          echo "ðŸ“¦ Installing cross-compilation dependencies..."
          sudo apt-get update
          
          # Install cross-compilation toolchain and build dependencies
          sudo apt-get install -y \
            crossbuild-essential-arm64 \
            build-essential \
            bison \
            flex \
            libssl-dev \
            bc \
            git \
            device-tree-compiler \
            u-boot-tools \
            dpkg-dev \
            debhelper \
            fakeroot \
            ccache
          
          echo "âœ… Dependencies installed successfully"

      - name: Cache build dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/apt
            /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('**/raphael-kernel_build.sh', '**/build-config.sh') }}
          restore-keys: |
            ${{ runner.os }}-apt-${{ hashFiles('**/raphael-kernel_build.sh') }}
            ${{ runner.os }}-apt-
            
      - name: Cache kernel build artifacts
        uses: actions/cache@v3
        with:
          path: |
            output/
          key: kernel-artifacts-${{ runner.os }}-${{ env.ARCH }}-${{ github.event.inputs.kernel_version }}-${{ hashFiles('**/raphael-kernel_build.sh', '**/build-config.sh', '**/DEBIAN/control') }}
          restore-keys: |
            kernel-artifacts-${{ runner.os }}-${{ env.ARCH }}-${{ github.event.inputs.kernel_version }}
            kernel-artifacts-${{ runner.os }}-${{ env.ARCH }}

      - name: Restore ccache cache
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: kernel-ccache-${{ runner.os }}-${{ env.ARCH }}-${{ github.event.inputs.kernel_version }}-${{ hashFiles('**/raphael-kernel_build.sh', '**/build-config.sh', '**/DEBIAN/control') }}
          restore-keys: |
            kernel-ccache-${{ runner.os }}-${{ env.ARCH }}-${{ github.event.inputs.kernel_version }}
            kernel-ccache-${{ runner.os }}-${{ env.ARCH }}
            
      - name: Configure ccache
        run: |
          echo "ðŸ”§ Configuring ccache..."
          mkdir -p ${{ env.CCACHE_DIR }}
          
          # Set ccache configuration using environment variables
          ccache -M ${{ env.CCACHE_MAXSIZE }} 2>/dev/null || echo "âš ï¸ Could not set cache size"
          ccache -o compiler_check=${{ env.CCACHE_COMPILERCHECK }} 2>/dev/null || echo "âš ï¸ Could not set compiler_check"
          ccache -o compress=${{ env.CCACHE_COMPRESS }} 2>/dev/null || echo "âš ï¸ Could not set compress"
          ccache -o sloppiness=${{ env.CCACHE_SLOPPINESS }} 2>/dev/null || echo "âš ï¸ Could not set sloppiness"
          
          # Create cross-compiler symlinks for ccache
          mkdir -p ${{ env.CCACHE_DIR }}/bin
          for c in aarch64-linux-gnu-gcc aarch64-linux-gnu-g++; do
            ln -sf $(which ccache) ${{ env.CCACHE_DIR }}/bin/$c 2>/dev/null || echo "âš ï¸ Could not create symlink for $c"
          done
          
          # Ensure proper permissions
          sudo chmod -R 777 ${{ env.CCACHE_DIR }} 2>/dev/null || echo "âš ï¸ Could not set permissions"
          
          # Show ccache configuration
          echo "ðŸ“Š Current ccache configuration:"
          ccache --show-config 2>/dev/null | grep -E "(compiler_check|compress|sloppiness|max_size)" || echo "âš ï¸ Could not show configuration"
          
          echo "âœ… ccache configuration completed"
            
      - name: Build kernel packages
        run: |
          chmod +x ./raphael-kernel_build.sh
          ./raphael-kernel_build.sh "${{ github.event.inputs.kernel_version }}"
          
      - name: Verify kernel packages
        run: |
          echo "ðŸ” Verifying generated kernel packages:"
          
          # Check if output directory exists
          if [ ! -d "output/kernel" ]; then
            echo "âš ï¸ Output directory not found, but continuing for cache upload"
            # Create empty directory to avoid path issues
            mkdir -p output/kernel
            echo "ðŸ“ Created empty output directory for cache preservation"
          else
            # List all generated files
            echo "ðŸ“ Generated files:"
            ls -la output/kernel/
          fi
          
      - name: Show ccache statistics after build
        run: |
          echo "ðŸ“Š ccache statistics after build:"
          ccache -s
          
          # Verify DEB packages with tolerance
          if ls output/kernel/*.deb 1> /dev/null 2>&1; then
            echo "âœ… Found DEB packages:"
            ls -la output/kernel/*.deb
            
            # Check package integrity
            for pkg in output/kernel/*.deb; do
              echo "ðŸ” Verifying package: $pkg"
              dpkg-deb -I "$pkg" || echo "âš ï¸ Package verification failed for $pkg"
            done
          else
            echo "âš ï¸ No DEB packages found, but continuing for cache upload"
            echo "ðŸ“ This may indicate a partial build, but cache will be preserved"
          fi
          
          # Verify kernel image
          if [ -f "output/kernel/Image.gz-${{ github.event.inputs.kernel_version }}" ]; then
            echo "âœ… Found kernel image: Image.gz-${{ github.event.inputs.kernel_version }}"
            file "output/kernel/Image.gz-${{ github.event.inputs.kernel_version }}"
          else
            echo "âš ï¸ Kernel image not found"
          fi
          
          # Verify DTB files
          if ls output/kernel/dtbs/sm8150-*.dtb 1> /dev/null 2>&1; then
            echo "âœ… Found DTB files:"
            ls -la output/kernel/dtbs/sm8150-*.dtb
          else
            echo "âš ï¸ DTB files not found"
          fi
          
          # Create build status file for debugging
          echo "ðŸ“ Creating build status file..."
          echo "Build completed at: $(date)" > build-status.txt
          echo "Kernel version: ${{ github.event.inputs.kernel_version }}" >> build-status.txt
          echo "DEB packages found: $(ls output/kernel/*.deb 2>/dev/null | wc -l)" >> build-status.txt
          echo "Kernel image found: $([ -f \"output/kernel/Image.gz-${{ github.event.inputs.kernel_version }}\" ] && echo \"yes\" || echo \"no\")" >> build-status.txt
          echo "DTB files found: $(ls output/kernel/dtbs/sm8150-*.dtb 2>/dev/null | wc -l)" >> build-status.txt
          
          # Always exit with success to ensure cache upload
          echo "âœ… Build verification completed (always successful for cache preservation)"
          exit 0
          
      - name: Upload kernel packages to release
        if: github.event.inputs.upload_to_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.kernel_version }}
          name: "Kernel ${{ github.event.inputs.kernel_version }} for Xiaomi Raphael"
          body: |
            # Kernel ${{ github.event.inputs.kernel_version }} for Xiaomi Raphael
            
            ## Build Information
            - Kernel Version: ${{ github.event.inputs.kernel_version }}
            - Architecture: ARM64
            - Target Device: Xiaomi Raphael (K20 Pro)
            - Build Date: ${{ github.event.repository.created_at }}
            - Build ID: ${{ github.run_id }}
            
            ## Generated Files
            - **Kernel Packages**: DEB packages for installation
            - **Kernel Image**: Raw kernel binary (Image.gz)
            - **DTB Files**: Device Tree Blobs for hardware configuration
            
            ## Usage
            
            ### Installing Kernel Packages:
            ```bash
            sudo dpkg -i linux-xiaomi-raphael_${{ github.event.inputs.kernel_version }}-1_arm64.deb
            ```
            
            ### For Boot Image Creation:
            Use the `Image.gz` file and corresponding DTB files with your boot image builder.
            
            ## Changelog
            - Kernel version update to ${{ github.event.inputs.kernel_version }}
            - Bug fixes and performance improvements
          files: |
            output/kernel/*.deb
            output/kernel/Image.gz-*
            output/kernel/dtbs/*
          draft: false
          prerelease: false
          
      - name: Save ccache cache
        if: always()  # Always save cache even if build fails
        uses: actions/cache/save@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: kernel-ccache-${{ runner.os }}-${{ env.ARCH }}-${{ github.event.inputs.kernel_version }}-${{ hashFiles('**/raphael-kernel_build.sh', '**/build-config.sh', '**/DEBIAN/control') }}
          
      - name: Upload kernel packages as artifacts
        if: github.event.inputs.upload_to_release != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: kernel-packages-${{ github.event.inputs.kernel_version }}
          path: |
            output/kernel/*.deb
            output/kernel/Image.gz-*
            output/kernel/dtbs/*
          retention-days: 30