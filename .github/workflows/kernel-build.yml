name: Kernel Build and Release

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version to build (e.g., 6.1.80)'
        required: true
        type: string
        default: '6.1.80'
      release_tag:
        description: 'Release tag for the kernel package'
        required: true
        type: string
        default: 'v6.1.80'
      upload_to_release:
        description: 'Upload kernel packages to GitHub Release'
        required: false
        type: boolean
        default: true

env:
  KERNEL_VERSION: ${{ github.event.inputs.kernel_version }}
  RELEASE_TAG: ${{ github.event.inputs.release_tag }}

jobs:
  build-kernel:
    name: Build Kernel Packages
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        echo "Building kernel version: $KERNEL_VERSION"
        echo "Release tag: $RELEASE_TAG"
        
    - name: Validate inputs
      run: |
        if [[ ! "$KERNEL_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "‚ùå Invalid kernel version format: $KERNEL_VERSION"
          exit 1
        fi
        
        if [[ ! "$RELEASE_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "‚ùå Invalid release tag format: $RELEASE_TAG"
          exit 1
        fi
        
    - name: Check available disk space
      run: |
        df -h
        AVAILABLE_SPACE=$(df / --output=avail | tail -1 | tr -d ' ')
        echo "Available disk space: ${AVAILABLE_SPACE}KB"
        
        # Require at least 10GB for kernel build
        if [ "$AVAILABLE_SPACE" -lt 10000000 ]; then
          echo "‚ùå Insufficient disk space for kernel build"
          exit 1
        fi
        
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          bc \
          git \
          wget \
          curl \
          debootstrap \
          qemu-user-static \
          binfmt-support \
          fakeroot \
          cpio \
          kmod \
          rsync
          
    - name: Setup ccache for faster builds
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: kernel-${{ github.event.inputs.kernel_version }}
        max-size: 500M
        
    - name: Build kernel packages
      run: |
        chmod +x ./raphael-kernel_build.sh
        ./raphael-kernel_build.sh --kernel-version "$KERNEL_VERSION" --verbose
        
    - name: Verify kernel packages
      run: |
        echo "üîç Verifying generated kernel packages:"
        ls -la *.deb || echo "No DEB packages found"
        
        # Check for required kernel packages
        REQUIRED_PACKAGES=("linux-xiaomi-raphael_${KERNEL_VERSION}_arm64.deb" 
                          "firmware-xiaomi-raphael_${KERNEL_VERSION}_arm64.deb"
                          "alsa-xiaomi-raphael_${KERNEL_VERSION}_arm64.deb")
        
        for pkg in "${REQUIRED_PACKAGES[@]}"; do
          if [ -f "$pkg" ]; then
            echo "‚úÖ Found: $pkg"
            # Verify package structure
            dpkg-deb -I "$pkg" || echo "‚ö†Ô∏è Package verification failed for $pkg"
          else
            echo "‚ùå Missing: $pkg"
            exit 1
          fi
        done
        
    - name: Create release tag
      if: github.event.inputs.upload_to_release == 'true'
      uses: actions/create-github-app-token@v1
      id: app-token
      with:
        app-id: ${{ vars.APP_ID }}
        private-key: ${{ secrets.APP_PRIVATE_KEY }}
        
    - name: Upload kernel packages to release
      if: github.event.inputs.upload_to_release == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.release_tag }}
        name: "Kernel ${{ github.event.inputs.kernel_version }} for Xiaomi Raphael"
        body: |
          # Kernel ${{ github.event.inputs.kernel_version }} for Xiaomi Raphael
          
          ## Package Contents
          - **linux-xiaomi-raphael**: Main kernel package
          - **firmware-xiaomi-raphael**: Firmware files
          - **alsa-xiaomi-raphael**: Audio drivers
          
          ## Usage
          These packages are designed for use with the Raphael rootfs build system.
          
          ## Build Information
          - Kernel Version: ${{ github.event.inputs.kernel_version }}
          - Architecture: ARM64
          - Target Device: Xiaomi Raphael (K20 Pro)
          
        files: |
          linux-xiaomi-raphael_*.deb
          firmware-xiaomi-raphael_*.deb
          alsa-xiaomi-raphael_*.deb
        draft: false
        prerelease: false
        token: ${{ steps.app-token.outputs.token }}
        
    - name: Upload kernel packages as artifacts
      if: github.event.inputs.upload_to_release != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-packages-${{ github.event.inputs.kernel_version }}
        path: |
          linux-xiaomi-raphael_*.deb
          firmware-xiaomi-raphael_*.deb
          alsa-xiaomi-raphael_*.deb
        retention-days: 30
        
    - name: Display build summary
      run: |
        echo "üéâ Kernel build completed successfully!"
        echo "üì¶ Kernel Version: $KERNEL_VERSION"
        echo "üè∑Ô∏è  Release Tag: $RELEASE_TAG"
        if [ "${{ github.event.inputs.upload_to_release }}" = "true" ]; then
          echo "üì§ Packages uploaded to GitHub Release: $RELEASE_TAG"
        else
          echo "üì¶ Packages saved as workflow artifacts"
        fi