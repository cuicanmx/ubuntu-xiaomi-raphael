name: Kernel Build and Release

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version and release tag (e.g., 6.18)'
        required: true
        type: string
        default: '6.18'
      upload_to_release:
        description: 'Upload kernel packages to GitHub Release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
    build-kernel:
      name: Build Kernel Packages
      runs-on: ubuntu-24.04-arm
      env:
        ARCH: arm64
      
      steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install build dependencies
        run: |
          echo "üì¶ Installing cross-compilation dependencies..."
          sudo apt-get update
          
          # Install cross-compilation toolchain and build dependencies
          sudo apt-get install -y \
            crossbuild-essential-arm64 \
            build-essential \
            bison \
            flex \
            libssl-dev \
            bc \
            git \
            device-tree-compiler \
            u-boot-tools \
            dpkg-dev \
            debhelper \
            fakeroot
          
          echo "‚úÖ Dependencies installed successfully"
            
      - name: Build kernel packages
        run: |
          chmod +x ./raphael-kernel_build.sh
          ./raphael-kernel_build.sh "${{ github.event.inputs.kernel_version }}"
          
      - name: Verify kernel packages
        run: |
          echo "üîç Verifying generated kernel packages:"
          
          # Check if output directory exists
          if [ ! -d "output/kernel" ]; then
            echo "‚ùå Output directory not found"
            exit 1
          else
            # List all generated files
            echo "üìÅ Generated files:"
            ls -la output/kernel/
          fi
          
          # Verify DEB packages
          if ls output/kernel/*.deb 1> /dev/null 2>&1; then
            echo "‚úÖ Found DEB packages:"
            ls -la output/kernel/*.deb
            
            # Check package integrity
            for pkg in output/kernel/*.deb; do
              echo "üîç Verifying package: $pkg"
              dpkg-deb -I "$pkg" || echo "‚ö†Ô∏è Package verification failed for $pkg"
            done
          else
            echo "‚ùå No DEB packages found"
            exit 1
          fi
          
          # Verify kernel image
          if [ -f "output/kernel/Image.gz-${{ github.event.inputs.kernel_version }}" ]; then
            echo "‚úÖ Found kernel image: Image.gz-${{ github.event.inputs.kernel_version }}"
            file "output/kernel/Image.gz-${{ github.event.inputs.kernel_version }}"
          else
            echo "‚ùå Kernel image not found"
            exit 1
          fi
          
          # Verify DTB files
          if ls output/kernel/dtbs/sm8150-*.dtb 1> /dev/null 2>&1; then
            echo "‚úÖ Found DTB files:"
            ls -la output/kernel/dtbs/sm8150-*.dtb
          else
            echo "‚ö†Ô∏è DTB files not found"
          fi
          
          echo "‚úÖ Build verification completed"
          
      - name: Upload kernel packages to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.kernel_version }}
          name: "Kernel ${{ github.event.inputs.kernel_version }} for Xiaomi Raphael"
          body: |
            # Kernel ${{ github.event.inputs.kernel_version }} for Xiaomi Raphael
            
            ## Build Information
            - Kernel Version: ${{ github.event.inputs.kernel_version }}
            - Architecture: ARM64
            - Target Device: Xiaomi Raphael (K20 Pro)
            - Build Date: ${{ github.event.repository.created_at }}
            - Build ID: ${{ github.run_id }}
            
            ## Generated Files
            - **Kernel Packages**: DEB packages for installation
            - **Kernel Image**: Raw kernel binary (Image.gz)
            - **DTB Files**: Device Tree Blobs for hardware configuration
            - **Compressed Archives**: Complete kernel build in tar.gz and zip formats
            
            ## Usage
            
            ### Installing Kernel Packages:
            ```bash
            sudo dpkg -i linux-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb
            ```
            
            ### Using Compressed Archives:
            Extract the compressed archive to get all kernel files in one place:
            ```bash
            tar -xzf kernel-${{ github.event.inputs.kernel_version }}-raphael.tar.gz
            # or
            unzip kernel-${{ github.event.inputs.kernel_version }}-raphael.zip
            ```
            
            ### For Boot Image Creation:
            Use the `Image.gz` file and corresponding DTB files with your boot image builder.
            
            ## Changelog
            - Kernel version update to ${{ github.event.inputs.kernel_version }}
            - Added compressed archive support for easier distribution
            - Bug fixes and performance improvements
          files: |
            output/kernel/*.deb
            output/kernel/Image.gz-*
            output/kernel/dtbs/*
            output/kernel/kernel-*.tar.gz
            output/kernel/kernel-*.zip
          draft: false
          prerelease: false