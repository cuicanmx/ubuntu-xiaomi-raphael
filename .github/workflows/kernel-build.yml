name: Kernel Build and Release

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version and release tag (e.g., 6.18)'
        required: true
        type: string
        default: '6.18'
      upload_to_release:
        description: 'Upload kernel packages to GitHub Release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
    build-kernel:
      name: Build Kernel Packages
      runs-on: ubuntu-24.04-arm
      env:
        ARCH: arm64
      
      steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y crossbuild-essential-arm64 build-essential bison flex libssl-dev bc git device-tree-compiler u-boot-tools dpkg-dev debhelper fakeroot
            
      - name: Build kernel packages
        run: |
          chmod +x ./raphael-kernel_build.sh
          ./raphael-kernel_build.sh "${{ github.event.inputs.kernel_version }}"
          
      - name: Verify kernel packages
        run: |
          [ -d "output/kernel" ] || { echo "Output directory not found"; exit 1; }
          
          ls output/kernel/*.deb 1> /dev/null 2>&1 || { echo "No DEB packages found"; exit 1; }
          
          for pkg in output/kernel/*.deb; do
            dpkg-deb -I "$pkg" || echo "Package verification failed for $pkg"
          done
          
          [ -f "output/kernel/Image.gz-${{ github.event.inputs.kernel_version }}" ] || { echo "Kernel image not found"; exit 1; }
          
          ls output/kernel/dtbs/sm8150-*.dtb 1> /dev/null 2>&1 || echo "DTB files not found"
          
      - name: Upload kernel packages to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.kernel_version }}
          name: "ğŸ”§ å°ç±³ Raphael å†…æ ¸ ${{ github.event.inputs.kernel_version }} - ä¸“ä¸º ARM64 ä¼˜åŒ–"
          body: |
            # ğŸ”§ å°ç±³ Raphael (K20 Pro) å†…æ ¸ ${{ github.event.inputs.kernel_version }}
            
            ## ğŸ·ï¸ å†…æ ¸ä¿¡æ¯
            
            ### ğŸ“Š åŸºæœ¬ä¿¡æ¯
            - **è®¾å¤‡å‹å·**: å°ç±³ Raphael (K20 Pro)
            - **å†…æ ¸ç‰ˆæœ¬**: ${{ github.event.inputs.kernel_version }}
            - **æ¶æ„å¹³å°**: ARM64
            - **ç›®æ ‡å¹³å°**: SM8150 (éªé¾™ 855)
            
            ### ğŸ”§ æ„å»ºè¯¦æƒ…
            - **æ„å»ºæ—¥æœŸ**: ${{ github.event.repository.created_at }}
            - **æ„å»ºID**: ${{ github.run_id }}
            - **å‘å¸ƒæ ‡ç­¾**: v${{ github.event.inputs.kernel_version }}
            
            ## ğŸ—‚ï¸ æ–‡ä»¶è¯´æ˜
            
            ### ğŸ“¦ å‹ç¼©å½’æ¡£åŒ…ï¼ˆæ¨èä½¿ç”¨ï¼‰
            - **å®Œæ•´å‹ç¼©åŒ…**: kernel-${{ github.event.inputs.kernel_version }}-raphael.tar.gz
            - **ZIP æ ¼å¼**: kernel-${{ github.event.inputs.kernel_version }}-raphael.zip
            
            ### ğŸ“ å‹ç¼©åŒ…å†…å®¹
            å‹ç¼©åŒ…åŒ…å«ä»¥ä¸‹å†…æ ¸åŒ…æ–‡ä»¶ï¼š
            - linux-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb
            - firmware-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb
            - alsa-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb
            
            ## ğŸ“‹ ä½¿ç”¨æŒ‡å—
            
            ### ğŸ“¦ ä½¿ç”¨å‹ç¼©å½’æ¡£ï¼ˆæ¨èï¼‰
            ```bash
            # è§£å‹ tar.gz æ ¼å¼
            tar -xzf kernel-${{ github.event.inputs.kernel_version }}-raphael.tar.gz
            
            # æˆ–è§£å‹ ZIP æ ¼å¼
            unzip kernel-${{ github.event.inputs.kernel_version }}-raphael.zip
            
            # å®‰è£…å†…æ ¸åŒ…
            sudo dpkg -i linux-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb
            sudo dpkg -i firmware-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb
            sudo dpkg -i alsa-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb
            ```
            
            ## ğŸ¯ è®¾å¤‡å…¼å®¹æ€§
            
            ### âœ… æ”¯æŒè®¾å¤‡
            - å°ç±³ Raphael (K20 Pro)
            - åŸºäº SM8150 å¹³å°çš„è®¾å¤‡
            
            ### ğŸ”§ ç¡¬ä»¶ç‰¹æ€§
            - éªé¾™ 855 å¤„ç†å™¨ä¼˜åŒ–
            - å®Œæ•´çš„ ARM64 æ”¯æŒ
            - é’ˆå¯¹ç§»åŠ¨è®¾å¤‡çš„ç”µæºç®¡ç†
            - ä¼˜åŒ–çš„ GPU å’Œæ˜¾ç¤ºé©±åŠ¨
            
            ## ğŸ“ æ›´æ–°æ—¥å¿—
            
            ### ğŸ”„ ç‰ˆæœ¬æ›´æ–°
            - **å†…æ ¸ç‰ˆæœ¬**: ${{ github.event.inputs.kernel_version }}
            - **è®¾å¤‡æ”¯æŒ**: é’ˆå¯¹å°ç±³ Raphael çš„ä¸“é—¨ä¼˜åŒ–
            - **æ€§èƒ½æ”¹è¿›**: ä¼˜åŒ–çš„è°ƒåº¦å™¨å’Œç”µæºç®¡ç†
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - æœ€æ–°çš„ Linux å†…æ ¸åŠŸèƒ½
            - é’ˆå¯¹ç§»åŠ¨è®¾å¤‡çš„ä¼˜åŒ–
            - ç¨³å®šçš„é©±åŠ¨æ”¯æŒ
            - å®Œæ•´çš„ ARM64 æ¶æ„æ”¯æŒ
            
            ## â“ å¸¸è§é—®é¢˜
            
            ### Q: å¦‚ä½•éªŒè¯å†…æ ¸å®‰è£…ï¼Ÿ
            A: é‡å¯åè¿è¡Œ `uname -r` æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬ã€‚
            
            ### Q: æ˜¯å¦éœ€è¦ç‰¹æ®Šé…ç½®ï¼Ÿ
            A: å†…æ ¸å·²é’ˆå¯¹è®¾å¤‡è¿›è¡Œé¢„é…ç½®ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚
            
            ### Q: æ”¯æŒå“ªäº›åŠŸèƒ½ï¼Ÿ
            A: æ”¯æŒå®Œæ•´çš„ Linux åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç½‘ç»œã€å­˜å‚¨ã€æ˜¾ç¤ºç­‰ã€‚
            
            ---
            
            *ğŸ’« ç”± GitHub Actions è‡ªåŠ¨æ„å»ºï¼Œä¸“ä¸ºå°ç±³ Raphael è®¾å¤‡ä¼˜åŒ–*
          files: |
            output/kernel/kernel-${{ github.event.inputs.kernel_version }}-raphael.tar.gz
            output/kernel/kernel-${{ github.event.inputs.kernel_version }}-raphael.zip
        if: ${{ github.event.inputs.upload_to_release == true }}