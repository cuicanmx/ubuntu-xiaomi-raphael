name: Kernel Build and Release

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version and release tag (e.g., 6.18)'
        required: true
        type: string
        default: '6.18'
      upload_to_release:
        description: 'Upload kernel packages to GitHub Release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
    build-kernel:
      name: Build Kernel Packages
      runs-on: ubuntu-latest
      env:
        CCACHE_DIR: ${{ github.workspace }}/.ccache
        CCACHE_MAXSIZE: 5G
        CCACHE_COMPILERCHECK: content
        CCACHE_COMPRESS: true
        CCACHE_SLOPPINESS: file_macro,locale,time_stamp
        ARCH: arm64
      
      steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            bison \
            flex \
            libssl-dev \
            bc \
            git \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            ccache

      - name: Cache build dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/apt
            /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('**/raphael-kernel_build.sh') }}
          restore-keys: |
            ${{ runner.os }}-apt-
            
      - name: Cache kernel build
        uses: actions/cache@v3
        with:
          path: |
            kernel-cache/
            linux-*/
            .ccache/
            output/
          key: ${{ runner.os }}-kernel-${{ github.event.inputs.kernel_version }}-${{ hashFiles('**/raphael-kernel_build.sh', '**/DEBIAN/control') }}
          restore-keys: |
            ${{ runner.os }}-kernel-${{ github.event.inputs.kernel_version }}-
            ${{ runner.os }}-kernel-

      - name: Configure ccache
        run: |
          mkdir -p ${{ env.CCACHE_DIR }}
          echo "max_size = ${{ env.CCACHE_MAXSIZE }}" > ${{ env.CCACHE_DIR }}/ccache.conf || true
          mkdir -p ${{ env.CCACHE_DIR }}/bin
          for c in aarch64-linux-gnu-gcc aarch64-linux-gnu-g++; do
            ln -sf $(which ccache) ${{ env.CCACHE_DIR }}/bin/$c || true
          done
          sudo chmod -R 777 ${{ env.CCACHE_DIR }}

      - name: Restore ccache
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: kernel-ccache-${{ runner.os }}-${{ env.ARCH }}-${{ github.event.inputs.kernel_version }}-${{ hashFiles('**/raphael-kernel_build.sh') }}
          restore-keys: |
            kernel-ccache-${{ runner.os }}-${{ env.ARCH }}-${{ github.event.inputs.kernel_version }}-
            kernel-ccache-${{ runner.os }}-${{ env.ARCH }}-
            
      - name: Build kernel packages
        run: |
          chmod +x ./raphael-kernel_build.sh
          ./raphael-kernel_build.sh "${{ github.event.inputs.kernel_version }}"
          
      - name: Verify kernel packages
        run: |
          echo "üîç Verifying generated kernel packages:"
          
          # Check if output directory exists
          if [ ! -d "output/kernel" ]; then
            echo "‚ùå Output directory not found"
            exit 1
          fi
          
          # List all generated files
          echo "üìÅ Generated files:"
          ls -la output/kernel/
          
          # Verify DEB packages
          if ls output/kernel/*.deb 1> /dev/null 2>&1; then
            echo "‚úÖ Found DEB packages:"
            ls -la output/kernel/*.deb
            
            # Check package integrity
            for pkg in output/kernel/*.deb; do
              echo "üîç Verifying package: $pkg"
              dpkg-deb -I "$pkg" || echo "‚ö†Ô∏è Package verification failed for $pkg"
            done
          else
            echo "‚ùå No DEB packages found"
            exit 1
          fi
          
          # Verify kernel image
          if [ -f "output/kernel/Image.gz-${{ github.event.inputs.kernel_version }}" ]; then
            echo "‚úÖ Found kernel image: Image.gz-${{ github.event.inputs.kernel_version }}"
            file "output/kernel/Image.gz-${{ github.event.inputs.kernel_version }}"
          else
            echo "‚ö†Ô∏è Kernel image not found"
          fi
          
          # Verify DTB files
          if ls output/kernel/dtbs/sm8150-*.dtb 1> /dev/null 2>&1; then
            echo "‚úÖ Found DTB files:"
            ls -la output/kernel/dtbs/sm8150-*.dtb
          else
            echo "‚ö†Ô∏è DTB files not found"
          fi
          
      - name: Upload kernel packages to release
        if: github.event.inputs.upload_to_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.kernel_version }}
          name: "Kernel ${{ github.event.inputs.kernel_version }} for Xiaomi Raphael"
          body: |
            # Kernel ${{ github.event.inputs.kernel_version }} for Xiaomi Raphael
            
            ## Build Information
            - Kernel Version: ${{ github.event.inputs.kernel_version }}
            - Architecture: ARM64
            - Target Device: Xiaomi Raphael (K20 Pro)
            - Build Date: ${{ github.event.repository.created_at }}
            - Build ID: ${{ github.run_id }}
            
            ## Generated Files
            - **Kernel Packages**: DEB packages for installation
            - **Kernel Image**: Raw kernel binary (Image.gz)
            - **DTB Files**: Device Tree Blobs for hardware configuration
            
            ## Usage
            
            ### Installing Kernel Packages:
            ```bash
            sudo dpkg -i linux-xiaomi-raphael_${{ github.event.inputs.kernel_version }}-1_arm64.deb
            ```
            
            ### For Boot Image Creation:
            Use the `Image.gz` file and corresponding DTB files with your boot image builder.
            
            ## Changelog
            - Kernel version update to ${{ github.event.inputs.kernel_version }}
            - Bug fixes and performance improvements
          files: |
            output/kernel/*.deb
            output/kernel/Image.gz-*
            output/kernel/dtbs/*
          draft: false
          prerelease: false
          
      - name: Upload kernel packages as artifacts
        if: github.event.inputs.upload_to_release != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: kernel-packages-${{ github.event.inputs.kernel_version }}
          path: |
            output/kernel/*.deb
            output/kernel/Image.gz-*
            output/kernel/dtbs/*
          retention-days: 30