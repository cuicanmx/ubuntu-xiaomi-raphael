name: Kernel Build and Release

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version and release tag (e.g., 6.18)'
        required: true
        type: string
        default: '6.18'
      upload_to_release:
        description: 'Upload kernel packages to GitHub Release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
    build-kernel:
      name: Build Kernel Packages
      runs-on: ubuntu-24.04-arm
      env:
        ARCH: arm64
      
      steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install build dependencies
        run: |
          echo "ğŸ“¦ Installing cross-compilation dependencies..."
          sudo apt-get update
          
          # Install cross-compilation toolchain and build dependencies
          sudo apt-get install -y \
            crossbuild-essential-arm64 \
            build-essential \
            bison \
            flex \
            libssl-dev \
            bc \
            git \
            device-tree-compiler \
            u-boot-tools \
            dpkg-dev \
            debhelper \
            fakeroot
          
          echo "âœ… Dependencies installed successfully"
            
      - name: Build kernel packages
        run: |
          chmod +x ./raphael-kernel_build.sh
          ./raphael-kernel_build.sh "${{ github.event.inputs.kernel_version }}"
          
      - name: Verify kernel packages
        run: |
          echo "ğŸ” Verifying generated kernel packages:"
          
          # Check if output directory exists
          if [ ! -d "output/kernel" ]; then
            echo "âŒ Output directory not found"
            exit 1
          else
            # List all generated files
            echo "ğŸ“ Generated files:"
            ls -la output/kernel/
          fi
          
          # Verify DEB packages
          if ls output/kernel/*.deb 1> /dev/null 2>&1; then
            echo "âœ… Found DEB packages:"
            ls -la output/kernel/*.deb
            
            # Check package integrity
            for pkg in output/kernel/*.deb; do
              echo "ğŸ” Verifying package: $pkg"
              dpkg-deb -I "$pkg" || echo "âš ï¸ Package verification failed for $pkg"
            done
          else
            echo "âŒ No DEB packages found"
            exit 1
          fi
          
          # Verify kernel image
          if [ -f "output/kernel/Image.gz-${{ github.event.inputs.kernel_version }}" ]; then
            echo "âœ… Found kernel image: Image.gz-${{ github.event.inputs.kernel_version }}"
            file "output/kernel/Image.gz-${{ github.event.inputs.kernel_version }}"
          else
            echo "âŒ Kernel image not found"
            exit 1
          fi
          
          # Verify DTB files
          if ls output/kernel/dtbs/sm8150-*.dtb 1> /dev/null 2>&1; then
            echo "âœ… Found DTB files:"
            ls -la output/kernel/dtbs/sm8150-*.dtb
          else
            echo "âš ï¸ DTB files not found"
          fi
          
          echo "âœ… Build verification completed"
          
      - name: Upload kernel packages to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.kernel_version }}
          name: "ğŸ”§ å°ç±³ Raphael å†…æ ¸ ${{ github.event.inputs.kernel_version }} - ä¸“ä¸º ARM64 ä¼˜åŒ–"
          body: |
            # ğŸ”§ å°ç±³ Raphael (K20 Pro) å†…æ ¸ ${{ github.event.inputs.kernel_version }}
            
            ## ğŸ·ï¸ å†…æ ¸ä¿¡æ¯
            
            ### ğŸ“Š åŸºæœ¬ä¿¡æ¯
            - **è®¾å¤‡å‹å·**: å°ç±³ Raphael (K20 Pro)
            - **å†…æ ¸ç‰ˆæœ¬**: ${{ github.event.inputs.kernel_version }}
            - **æ¶æ„å¹³å°**: ARM64
            - **ç›®æ ‡å¹³å°**: SM8150 (éªé¾™ 855)
            
            ### ğŸ”§ æ„å»ºè¯¦æƒ…
            - **æ„å»ºæ—¥æœŸ**: ${{ github.event.repository.created_at }}
            - **æ„å»ºID**: ${{ github.run_id }}
            - **å‘å¸ƒæ ‡ç­¾**: v${{ github.event.inputs.kernel_version }}
            
            ## ğŸ—‚ï¸ æ–‡ä»¶è¯´æ˜
            
            ### ğŸ“¦ å†…æ ¸åŒ…æ–‡ä»¶
            - **DEB å®‰è£…åŒ…**: linux-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb
            - **å†…æ ¸é•œåƒ**: Image.gz-${{ github.event.inputs.kernel_version }}
            - **è®¾å¤‡æ ‘æ–‡ä»¶**: dtbs/sm8150-*.dtb
            
            ### ğŸ“ å‹ç¼©å½’æ¡£
            - **å®Œæ•´å‹ç¼©åŒ…**: kernel-${{ github.event.inputs.kernel_version }}-raphael.tar.gz
            - **ZIP æ ¼å¼**: kernel-${{ github.event.inputs.kernel_version }}-raphael.zip
            
            ## ğŸ“‹ ä½¿ç”¨æŒ‡å—
            
            ### ğŸ”§ å®‰è£…å†…æ ¸åŒ…
            ```bash
            # å®‰è£… DEB åŒ…
            sudo dpkg -i linux-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb
            
            # å®‰è£…ä¾èµ–
            sudo apt-get install -f
            ```
            
            ### ğŸ“¦ ä½¿ç”¨å‹ç¼©å½’æ¡£
            ```bash
            # è§£å‹ tar.gz æ ¼å¼
            tar -xzf kernel-${{ github.event.inputs.kernel_version }}-raphael.tar.gz
            
            # æˆ–è§£å‹ ZIP æ ¼å¼
            unzip kernel-${{ github.event.inputs.kernel_version }}-raphael.zip
            ```
            
            ### ğŸš€ å¯åŠ¨é•œåƒæ„å»º
            ä½¿ç”¨ Image.gz æ–‡ä»¶å’Œå¯¹åº”çš„ DTB æ–‡ä»¶è¿›è¡Œå¯åŠ¨é•œåƒæ„å»ºï¼š
            ```bash
            # æå–å†…æ ¸é•œåƒå’Œ DTB æ–‡ä»¶
            cp output/kernel/Image.gz-${{ github.event.inputs.kernel_version }} ./kernel-image
            cp output/kernel/dtbs/sm8150-*.dtb ./dtb-files/
            ```
            
            ## ğŸ¯ è®¾å¤‡å…¼å®¹æ€§
            
            ### âœ… æ”¯æŒè®¾å¤‡
            - å°ç±³ Raphael (K20 Pro)
            - åŸºäº SM8150 å¹³å°çš„è®¾å¤‡
            
            ### ğŸ”§ ç¡¬ä»¶ç‰¹æ€§
            - éªé¾™ 855 å¤„ç†å™¨ä¼˜åŒ–
            - å®Œæ•´çš„ ARM64 æ”¯æŒ
            - é’ˆå¯¹ç§»åŠ¨è®¾å¤‡çš„ç”µæºç®¡ç†
            - ä¼˜åŒ–çš„ GPU å’Œæ˜¾ç¤ºé©±åŠ¨
            
            ## ğŸ“ æ›´æ–°æ—¥å¿—
            
            ### ğŸ”„ ç‰ˆæœ¬æ›´æ–°
            - **å†…æ ¸ç‰ˆæœ¬**: ${{ github.event.inputs.kernel_version }}
            - **è®¾å¤‡æ”¯æŒ**: é’ˆå¯¹å°ç±³ Raphael çš„ä¸“é—¨ä¼˜åŒ–
            - **æ€§èƒ½æ”¹è¿›**: ä¼˜åŒ–çš„è°ƒåº¦å™¨å’Œç”µæºç®¡ç†
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - æœ€æ–°çš„ Linux å†…æ ¸åŠŸèƒ½
            - é’ˆå¯¹ç§»åŠ¨è®¾å¤‡çš„ä¼˜åŒ–
            - ç¨³å®šçš„é©±åŠ¨æ”¯æŒ
            - å®Œæ•´çš„ ARM64 æ¶æ„æ”¯æŒ
            
            ## â“ å¸¸è§é—®é¢˜
            
            ### Q: å¦‚ä½•éªŒè¯å†…æ ¸å®‰è£…ï¼Ÿ
            A: é‡å¯åè¿è¡Œ `uname -r` æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬ã€‚
            
            ### Q: æ˜¯å¦éœ€è¦ç‰¹æ®Šé…ç½®ï¼Ÿ
            A: å†…æ ¸å·²é’ˆå¯¹è®¾å¤‡è¿›è¡Œé¢„é…ç½®ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚
            
            ### Q: æ”¯æŒå“ªäº›åŠŸèƒ½ï¼Ÿ
            A: æ”¯æŒå®Œæ•´çš„ Linux åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç½‘ç»œã€å­˜å‚¨ã€æ˜¾ç¤ºç­‰ã€‚
            
            ---
            
            *ğŸ’« ç”± GitHub Actions è‡ªåŠ¨æ„å»ºï¼Œä¸“ä¸ºå°ç±³ Raphael è®¾å¤‡ä¼˜åŒ–*