name: Kernel Build and Release

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version (e.g., 6.18)'
        required: true
        type: string
        default: '6.18'
      upload_to_release:
        description: 'Upload kernel packages to GitHub Release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
    build-kernel:
      name: Build Kernel Packages
      runs-on: ubuntu-24.04-arm
      env:
        ARCH: arm64
      
      steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y crossbuild-essential-arm64 build-essential bison flex libssl-dev bc git device-tree-compiler u-boot-tools dpkg-dev debhelper fakeroot ccache
          
      - name: Configure ccache
        run: |
          ccache --version
          export CCACHE_DIR=/tmp/ccache-cache
          export CCACHE_MAXSIZE=20G
          ccache --show-config
          ccache -s -v
          
      - name: Restore ccache
        uses: actions/cache@v3
        with:
          path: /tmp/ccache-cache
          key: kernel-ccache
              
      - name: Build kernel packages
        run: |
          chmod +x ./raphael-kernel_build.sh
          ./raphael-kernel_build.sh "${{ github.event.inputs.kernel_version }}"

      - name: Upload kernel packages to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kernel-${{ github.event.inputs.kernel_version }}
          name: "ğŸ”§ å°ç±³ Raphael å†…æ ¸ ${{ github.event.inputs.kernel_version }} - ä¸“ä¸º ARM64 ä¼˜åŒ–"
          generate_release_notes: true
          draft: false
          body: |
            ### ğŸ“Š åŸºæœ¬ä¿¡æ¯
            - **è®¾å¤‡å‹å·**: å°ç±³ Raphael (K20 Pro)
            - **å†…æ ¸ç‰ˆæœ¬**: ${{ github.event.inputs.kernel_version }}
            - **æ¶æ„å¹³å°**: ARM64
            - **ç›®æ ‡å¹³å°**: SM8150 (éªé¾™ 855)
            
            ### ğŸ”§ æ„å»ºè¯¦æƒ…
            - **æ„å»ºæ—¥æœŸ**: ${{ github.event.repository.created_at }}
            - **æ„å»ºID**: ${{ github.run_id }}
            - **å‘å¸ƒæ ‡ç­¾**: v${{ github.event.inputs.kernel_version }}
            
            ## ğŸ—‚ï¸ æ–‡ä»¶è¯´æ˜
            
            ### ğŸ“¦ å‹ç¼©å½’æ¡£åŒ…ï¼ˆæ¨èä½¿ç”¨ï¼‰
            - **å®Œæ•´å‹ç¼©åŒ…**: kernel-${{ github.event.inputs.kernel_version }}-raphael.tar.gz
            
            ### ğŸ“ å‹ç¼©åŒ…å†…å®¹
            å‹ç¼©åŒ…åŒ…å«ä»¥ä¸‹å†…æ ¸åŒ…æ–‡ä»¶ï¼š
            - linux-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb
            - firmware-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb
            - alsa-xiaomi-raphael_${{ github.event.inputs.kernel_version }}_arm64.deb
            
            ### âœ… æ”¯æŒè®¾å¤‡
            - Raphael (K20 Pro)
            
            *ğŸ’« ç”± GitHub Actions è‡ªåŠ¨æ„å»ºï¼Œä¸“ä¸ºå°ç±³ Raphael è®¾å¤‡ä¼˜åŒ–*
          files: |
            output/kernel/kernel-*-raphael.tar.gz
      
      - name: Check ccache stats
        run: |
          ccache --show-stats
          ccache -s -v


      - name: Save ccache
        if: always()
        uses: actions/cache/save@v3
        with:
          path: /tmp/ccache-cache
          key: kernel-ccache