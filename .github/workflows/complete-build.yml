# Enhanced workflow for building both rootfs and boot image with multi-distro support

name: Complete Build (RootFS + Boot Image)

permissions:
  contents: write

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version and release tag (e.g., 6.18)'
        required: true
        type: string
        default: '6.18'
      distribution:
        description: 'Distribution to build (ubuntu/armbian)'
        required: true
        default: 'ubuntu'
        type: choice
        options:
          - ubuntu
          - armbian
      version:
        description: 'Distribution version'
        required: true
        default: 'noble'
        type: choice
        options:
          - noble
          - jammy
          - focal
      kernel_source:
        description: 'Source of kernel packages (release only)'
        required: true
        default: 'release'
        type: choice
        options:
          - release
      desktop_environment:
        description: 'Desktop environment to install (only for ubuntu)'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - xfce
          - gnome
          - kde

env:
  KERNEL_VERSION: ${{ github.event.inputs.kernel_version }}
  DISTRIBUTION: ${{ github.event.inputs.distribution }}
  KERNEL_SOURCE: ${{ github.event.inputs.kernel_source }}
  RELEASE_TAG: v${{ github.event.inputs.kernel_version }}
  DESKTOP_ENVIRONMENT: ${{ github.event.inputs.desktop_environment }}

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # Build root filesystem and boot image in sequence
  complete-build:
    name: Complete Build (RootFS + Boot Image)
    runs-on: ubuntu-24.04-arm  
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment variables
      run: |
        echo "Building for distribution: $DISTRIBUTION"
        echo "Kernel version: $KERNEL_VERSION"
        echo "Kernel source: $KERNEL_SOURCE"
        echo "Release tag: $RELEASE_TAG"
        echo "Desktop environment: $DESKTOP_ENVIRONMENT"
        
    - name: Setup inputs
      run: |
        echo "ğŸš€ Starting complete build process"
        echo "ğŸ“¦ Distribution: $DISTRIBUTION"
        echo "ğŸ”§ Kernel Version: $KERNEL_VERSION"
        echo "ğŸ“ Kernel Source: $KERNEL_SOURCE"
        if [[ "$KERNEL_SOURCE" == "release" ]]; then
          echo "ğŸ·ï¸  Release Tag: $RELEASE_TAG"
        fi
         
    - name: Download kernel packages from GitHub Release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        set -e  # Exit on any error
        
        echo "ğŸ“¥ Downloading kernel packages from GitHub Release: $RELEASE_TAG"
        
        # Download compressed kernel archive only (silent mode)
        echo "ğŸ” Downloading compressed kernel archive..."
        if ! gh release download $RELEASE_TAG \
          --pattern "kernel-*-raphael.tar.gz" \
          --pattern "kernel-*-raphael.zip" \
          --repo ${{ github.repository }} >/dev/null 2>&1; then
          echo "âŒ Failed to download kernel packages"
          echo "ğŸ“¦ Available files in release:"
          gh release view $RELEASE_TAG --repo ${{ github.repository }} --json assets --jq '.assets[].name'
          exit 1
        fi
        
        # Extract the compressed archive
        echo "ğŸ“¦ Extracting kernel archive..."
        tar_file=$(find . -name "kernel-*-raphael.tar.gz" -type f | head -1)
        zip_file=$(find . -name "kernel-*-raphael.zip" -type f | head -1)
        
        if [ -f "$tar_file" ]; then
          tar -xzf "$tar_file" >/dev/null 2>&1
          echo "âœ… tar.gz archive extracted successfully"
        elif [ -f "$zip_file" ]; then
          unzip -q "$zip_file"
          echo "âœ… zip archive extracted successfully"
        else
          echo "âŒ No compressed kernel archive found"
          echo "ğŸ“¦ Available files:"
          ls -la
          exit 1
        fi
        
        # Verify extracted packages
        echo "ğŸ” Verifying extracted kernel packages..."
        
        # Use wildcard pattern to match actual package names with full version
        REQUIRED_PACKAGES=("linux-xiaomi-raphael_*_arm64.deb" 
                          "firmware-xiaomi-raphael_*_arm64.deb"
                          "alsa-xiaomi-raphael_*_arm64.deb")
        
        all_found=true
        for pkg_pattern in "${REQUIRED_PACKAGES[@]}"; do
          # Find the actual package file matching the pattern
          pkg_file=$(find . -name "$pkg_pattern" -type f | head -1)
          
          if [ -f "$pkg_file" ]; then
            echo "âœ… Found: $pkg_file"
            # Verify package structure (silent)
            dpkg-deb -I "$pkg_file" >/dev/null 2>&1 || echo "âš ï¸ Package verification failed for $pkg_file"
          else
            echo "âŒ Missing package matching pattern: $pkg_pattern"
            all_found=false
          fi
        done
        
        if [ "$all_found" = false ]; then
          echo "ğŸ“ Available .deb files:"
          ls -la *.deb 2>/dev/null || echo "No .deb files found"
          exit 1
        fi
        
    - name: Install build dependencies
      run: |
         set -e  # Exit on any error
         
         echo "ğŸ“¦ Installing build dependencies..."
         echo "ğŸ”„ Updating package lists..."
         sudo apt update -y >/dev/null 2>&1 || { echo "âŒ Failed to update package lists"; exit 1; }
         
         # åŸºç¡€ä¾èµ–åŒ…
         BASE_DEPS="fakeroot cpio kmod rsync wget curl file parted dosfstools e2fsprogs util-linux systemd-container jq kpartx binfmt-support"
         
         # åœ¨ARM64æ¶æ„ä¸Šå®‰è£…ä¾èµ–ï¼ˆç®€åŒ–è¾“å‡ºï¼‰
         echo "ğŸ”§ Running on ARM64, installing native dependencies..."
         if ! sudo apt install -y $BASE_DEPS >/dev/null 2>&1; then
           echo "âŒ Failed to install build dependencies"
           echo "ğŸ“‹ Full installation output:"
           sudo apt install -y $BASE_DEPS
           exit 1
         fi
         echo "âœ… Build dependencies installed successfully"

    - name: Build rootfs
      run: |
         set -e  # Exit on any error
         echo "ğŸš€ Starting rootfs build for distribution: $DISTRIBUTION"
         echo "ğŸ“¦ Kernel version: $KERNEL_VERSION"
         echo "ğŸ–¥ï¸  Desktop environment: $DESKTOP_ENVIRONMENT"
         echo "ğŸ“¥ Kernel source: $KERNEL_SOURCE"
         
         # Set environment variables for the build script
         export KERNEL_VERSION="$KERNEL_VERSION"
         export DISTRIBUTION="$DISTRIBUTION"
         export DESKTOP_ENVIRONMENT="$DESKTOP_ENVIRONMENT"
         export KERNEL_SOURCE="$KERNEL_SOURCE"
         export GITHUB_WORKSPACE="$GITHUB_WORKSPACE"
         
         # Build rootfs with error handling
         if ! sudo bash ./raphael-rootfs_build.sh; then
           echo "âŒ RootFS build failed!"
           exit 1
         fi
         echo "âœ… RootFS build completed successfully for $DISTRIBUTION"

    - name: Validate rootfs build artifacts
      run: |
         set -e  # Exit on any error
         
         echo "ğŸ” Validating rootfs build artifacts..."
         ROOTFS_IMAGE="root-${DISTRIBUTION}-${KERNEL_VERSION}.img"
         
         # Check if image exists and is not empty
         if [ ! -f "$ROOTFS_IMAGE" ]; then
           echo "âŒ Missing rootfs image file: $ROOTFS_IMAGE"
           echo "ğŸ“ Available files:"
           ls -la *.img
           exit 1
         fi
         
         if [ ! -s "$ROOTFS_IMAGE" ]; then
           echo "âŒ RootFS image is empty or invalid"
           exit 1
         fi
         
         echo "âœ… Rootfs image found: $ROOTFS_IMAGE"
         echo "ğŸ“Š Image size: $(du -h "$ROOTFS_IMAGE" | cut -f1)"
         
         # Mount and verify content (simplified)
         echo "ğŸ”„ Mounting rootfs for content verification..."
         sudo kpartx -a "$ROOTFS_IMAGE" >/dev/null 2>&1 || { echo "âŒ Failed to mount rootfs for verification"; exit 1; }
         sleep 2
         
         if [ -b /dev/mapper/loop0p2 ]; then
           sudo mkdir -p /mnt/rootfs
           sudo mount /dev/mapper/loop0p2 /mnt/rootfs >/dev/null 2>&1 || { echo "âŒ Failed to mount rootfs partition"; exit 1; }
           
           # Check key files
           echo "ğŸ” Checking key files in rootfs..."
           key_files=("/mnt/rootfs/etc/hostname" "/mnt/rootfs/etc/fstab" "/mnt/rootfs/boot/vmlinuz*" "/mnt/rootfs/lib/modules")
           all_found=true
           for file in "${key_files[@]}"; do
             if [ -e "$file" ]; then
               echo "âœ… Found: $file"
             else
               echo "âš ï¸ Missing: $file"
               all_found=false
             fi
           done
           
           # Check kernel modules
           if ls /mnt/rootfs/lib/modules/$KERNEL_VERSION* 1> /dev/null 2>&1; then
             echo "âœ… Kernel modules found"
           else
             echo "âš ï¸ Kernel modules not found"
           fi
           
           # Cleanup
           sudo umount /mnt/rootfs >/dev/null 2>&1 || echo "âš ï¸ Failed to unmount rootfs"
           sudo rmdir /mnt/rootfs 2>/dev/null || true
         fi
         
         sudo kpartx -d "$ROOTFS_IMAGE" >/dev/null 2>&1 || echo "âš ï¸ Failed to clean up loop device"
         echo "âœ… Rootfs validation completed"

    - name: Compress rootfs image
      run: |
         set -e  # Exit on any error
         
         ROOTFS_IMAGE="root-${DISTRIBUTION}-${KERNEL_VERSION}.img"
         ZIP_FILE="root-${DISTRIBUTION}-${KERNEL_VERSION}.zip"
         
         echo "ğŸ—œï¸ Compressing rootfs image..."
         if ! zip -9 "$ZIP_FILE" "$ROOTFS_IMAGE" >/dev/null 2>&1; then
           echo "âŒ Failed to compress rootfs image"
           exit 1
         fi
         
         echo "ğŸ” Verifying compressed image integrity..."
         if ! unzip -t "$ZIP_FILE" >/dev/null 2>&1; then
           echo "âŒ Zip file integrity check failed"
           exit 1
         fi
         
         echo "âœ… Rootfs image compressed successfully"
         echo "ğŸ“Š Original size: $(du -h "$ROOTFS_IMAGE" | cut -f1)"
         echo "ğŸ“Š Compressed size: $(du -h "$ZIP_FILE" | cut -f1)"
         
    - name: Build boot image using script
      run: |
        set -e  # Exit on any error
        
        echo "ğŸš€ Building boot image..."
        chmod +x raphael-boot_build.sh
        
        ROOTFS_IMG="root-${DISTRIBUTION}-${KERNEL_VERSION}.img"
        BOOT_OUTPUT="xiaomi-k20pro-boot-${DISTRIBUTION}-${KERNEL_VERSION}.img"
        
        echo "ğŸ“‹ Boot image build parameters:"
        echo "   - Kernel version: $KERNEL_VERSION"
        echo "   - Distribution: $DISTRIBUTION"
        echo "   - Rootfs image: $ROOTFS_IMG"
        echo "   - Output: $BOOT_OUTPUT"
        
        if ! ./raphael-boot_build.sh \
          --kernel-version "$KERNEL_VERSION" \
          --distribution "$DISTRIBUTION" \
          --rootfs-image "$ROOTFS_IMG" \
          --output "$BOOT_OUTPUT"; then
          echo "âŒ Boot image build failed"
          exit 1
        fi
        
        # Extract rootfs UUID for documentation
        ROOTFS_UUID=$(./raphael-boot_build.sh --kernel-version "$KERNEL_VERSION" --distribution "$DISTRIBUTION" --rootfs-image "$ROOTFS_IMG" --dry-run 2>&1 | grep "Rootfs UUID:" | tail -1 | awk '{print $NF}' || echo "")
        [ -n "$ROOTFS_UUID" ] && echo "ROOTFS_UUID=$ROOTFS_UUID" >> $GITHUB_ENV
        
        echo "âœ… Boot image built successfully: $BOOT_OUTPUT"
        
    - name: Verify boot image
      run: |
        set -e  # Exit on any error
        
        echo "ğŸ” Verifying boot image..."
        BOOT_IMG="xiaomi-k20pro-boot-${DISTRIBUTION}-${KERNEL_VERSION}.img"
        
        if [ ! -f "$BOOT_IMG" ]; then
          echo "âŒ Boot image not found: $BOOT_IMG"
          exit 1
        fi
        
        # Check image size
        IMG_SIZE=$(stat -c%s "$BOOT_IMG")
        MIN_SIZE=$((200 * 1024 * 1024))
        MAX_SIZE=$((500 * 1024 * 1024))
        echo "ğŸ“Š Boot image size: $(du -h "$BOOT_IMG" | cut -f1)"
        
        if [ "$IMG_SIZE" -lt "$MIN_SIZE" ] || [ "$IMG_SIZE" -gt "$MAX_SIZE" ]; then
          echo "âš ï¸ Boot image size outside expected range ($((MIN_SIZE/1024/1024))MB - $((MAX_SIZE/1024/1024))MB)"
        fi
        
        # Mount and verify content
        echo "ğŸ”„ Mounting boot image for content verification..."
        mkdir -p /tmp/boot-mount
        if ! sudo mount -o loop "$BOOT_IMG" /tmp/boot-mount >/dev/null 2>&1; then
          echo "âŒ Failed to mount boot image"
          exit 1
        fi
        
        # Check essential files
        echo "ğŸ” Checking essential boot files..."
        essential_files=("/tmp/boot-mount/EFI/boot/bootaa64.efi" "/tmp/boot-mount/loader/entries/ubuntu.conf" "/tmp/boot-mount/linux.efi" "/tmp/boot-mount/initramfs")
        all_found=true
        
        for file in "${essential_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… Found: $file"
          else
            echo "âš ï¸ Missing: $file"
            all_found=false
          fi
        done
        
        # Check kernel version in configuration
        if [ -f "/tmp/boot-mount/loader/entries/ubuntu.conf" ]; then
          if grep -q "$KERNEL_VERSION" /tmp/boot-mount/loader/entries/ubuntu.conf; then
            echo "âœ… Kernel version in boot entry matches: $KERNEL_VERSION"
          else
            echo "âš ï¸ Kernel version in boot entry does not match expected: $KERNEL_VERSION"
            echo "ğŸ“‹ Current boot entry:"
            cat /tmp/boot-mount/loader/entries/ubuntu.conf
          fi
        fi
        
        # Cleanup
        sudo umount /tmp/boot-mount >/dev/null 2>&1 || echo "âš ï¸ Failed to unmount boot image"
        rmdir /tmp/boot-mount >/dev/null 2>&1 || true
        
        if [ "$all_found" = true ]; then
          echo "âœ… Boot image verification completed successfully"
        else
          echo "âš ï¸ Boot image verification found some issues - please review the warnings above"
        fi
        
    - name: Prepare release files
      run: |
        echo "ğŸ“ Preparing release-files directory"
        rm -rf release-files || true
        mkdir -p release-files
        # Copy all build artifacts
        cp -r *.img release-files/ 2>/dev/null || true
        cp -r *.zip release-files/ 2>/dev/null || true
        cp -r *.7z release-files/ 2>/dev/null || true
        cp -r *.deb release-files/ 2>/dev/null || true
        echo "ğŸ“‹ Release files:"
        ls -la release-files || true
        echo "ğŸ“ Release files structure:"
        find release-files -type f | head -20 || true

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: "ğŸ¯ å°ç±³ Raphael å®Œæ•´æ„å»º ${{ github.event.inputs.kernel_version }} - RootFS + Boot Image"
        body: |
          # ğŸ¯ å°ç±³ Raphael (K20 Pro) å®Œæ•´æ„å»º ${{ github.event.inputs.kernel_version }}
          
          ## ğŸ“¦ æ„å»ºä¿¡æ¯
          
          ### ğŸ“Š åŸºæœ¬ä¿¡æ¯
          - **è®¾å¤‡å‹å·**: å°ç±³ Raphael (K20 Pro)
          - **å†…æ ¸ç‰ˆæœ¬**: ${{ github.event.inputs.kernel_version }}
          - **å‘è¡Œç‰ˆæœ¬**: ${{ github.event.inputs.distribution }}
          - **æ¡Œé¢ç¯å¢ƒ**: ${{ github.event.inputs.desktop_environment }}
          - **æ¶æ„å¹³å°**: ARM64
          - **ç›®æ ‡å¹³å°**: SM8150 (éªé¾™ 855)
          
          ### ğŸ”§ æ„å»ºè¯¦æƒ…
          - **æ„å»ºæ—¥æœŸ**: ${{ github.event.repository.created_at }}
          - **æ„å»ºID**: ${{ github.run_id }}
          - **å‘å¸ƒæ ‡ç­¾**: ${{ env.RELEASE_TAG }}
          
          ## ğŸ—‚ï¸ æ–‡ä»¶è¯´æ˜
          
          ### ğŸ”§ RootFS ç³»ç»Ÿé•œåƒ
          - **å®Œæ•´é•œåƒ**: root-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}.img
          - **å‹ç¼©ç‰ˆæœ¬**: root-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}.zip
          - **7zå‹ç¼©ç‰ˆæœ¬**: root-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}.7z
          
          ### ğŸš€ Boot å¯åŠ¨é•œåƒ
          - **å®Œæ•´å¯åŠ¨é•œåƒ**: xiaomi-k20pro-boot-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}.img
          - **åŒ…å«å†…å®¹**: å†…æ ¸ã€è®¾å¤‡æ ‘ã€åˆå§‹åŒ–è„šæœ¬
          
          ## ğŸ“‹ ä½¿ç”¨æŒ‡å—
          
          ### ğŸ”¥ åˆ·æœºè¯´æ˜
          ```bash
          # è§£å‹ RootFS é•œåƒ
          unzip root-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}.zip
          
          # åˆ·å…¥è®¾å¤‡ (æ ¹æ®æ‚¨çš„è®¾ç½®è°ƒæ•´)
          fastboot flash system root-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}.img
          
          # åˆ·å…¥å¯åŠ¨é•œåƒ
          fastboot flash boot xiaomi-k20pro-boot-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}.img
          
          # é‡å¯è®¾å¤‡
          fastboot reboot
          ```
          
          ### ğŸ’¡ ä½¿ç”¨æç¤º
          - å»ºè®®å…ˆä½¿ç”¨ fastboot boot å‘½ä»¤ä¸´æ—¶æµ‹è¯•å¯åŠ¨é•œåƒ
          - ç¡®ä¿è®¾å¤‡å·²è§£é” bootloader
          - å»ºè®®åœ¨åˆ·æœºå‰å¤‡ä»½é‡è¦æ•°æ®
          - å¯ä»¥ä½¿ç”¨ 7z å‹ç¼©ç‰ˆæœ¬ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´
          
          ## ğŸ¯ è®¾å¤‡å…¼å®¹æ€§
          
          ### âœ… æ”¯æŒè®¾å¤‡
          - å°ç±³ Raphael (K20 Pro)
          - åŸºäº SM8150 å¹³å°çš„è®¾å¤‡
          
          ### ğŸ”§ ç¡¬ä»¶è¦æ±‚
          - ARM64 æ¶æ„å¤„ç†å™¨
          - è‡³å°‘ 2GB å¯ç”¨å­˜å‚¨ç©ºé—´
          - å·²è§£é”çš„ bootloader
          
          ## ğŸ“ æ›´æ–°æ—¥å¿—
          
          ### ğŸ”„ ç‰ˆæœ¬æ›´æ–°
          - **å†…æ ¸ç‰ˆæœ¬**: ${{ github.event.inputs.kernel_version }}
          - **å‘è¡Œç‰ˆæœ¬**: ${{ github.event.inputs.distribution }}
          - **æ¡Œé¢ç¯å¢ƒ**: ${{ github.event.inputs.desktop_environment }}
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - å®Œæ•´çš„ Linux å‘è¡Œç‰ˆä½“éªŒ
          - ä¼˜åŒ–çš„ ARM64 æ€§èƒ½
          - é’ˆå¯¹å°ç±³ Raphael è®¾å¤‡çš„ä¸“é—¨ä¼˜åŒ–
          - ç¨³å®šçš„å†…æ ¸å’Œç³»ç»Ÿç»„ä»¶
          
          ## â“ å¸¸è§é—®é¢˜
          
          ### Q: å¦‚ä½•éªŒè¯é•œåƒå®Œæ•´æ€§ï¼Ÿ
          A: ä¸‹è½½åæ£€æŸ¥æ–‡ä»¶å¤§å°å’Œå“ˆå¸Œå€¼ï¼Œç¡®ä¿æ–‡ä»¶å®Œæ•´ã€‚
          
          ### Q: æ˜¯å¦éœ€è¦ç‰¹æ®Šå·¥å…·ï¼Ÿ
          A: éœ€è¦ fastboot å·¥å…·å’Œå·²è§£é”çš„ bootloaderã€‚
          
          ### Q: æ”¯æŒå“ªäº›æ¡Œé¢ç¯å¢ƒï¼Ÿ
          A: å½“å‰æ”¯æŒ ${{ github.event.inputs.desktop_environment }} æ¡Œé¢ç¯å¢ƒã€‚
          
          ---          
          *ğŸ’« ç”± GitHub Actions è‡ªåŠ¨æ„å»ºï¼Œä¸“ä¸ºå°ç±³ Raphael è®¾å¤‡ä¼˜åŒ–*