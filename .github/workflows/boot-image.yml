name: Boot Image Creation

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version for boot image (e.g., 6.18)'
        required: true
        type: string
        default: '6.18'
      distribution:
        description: 'Distribution to use (ubuntu/armbian)'
        required: true
        type: string
        default: 'ubuntu'

env:
  KERNEL_VERSION: ${{ github.event.inputs.kernel_version }}
  DISTRIBUTION: ${{ github.event.inputs.distribution }}
  RELEASE_TAG: v${{ github.event.inputs.kernel_version }}

jobs:
  create-boot-image:
    name: Create Boot Image
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        echo "ğŸ”§ Creating boot image for $DISTRO with kernel $KERNEL_VERSION"
        echo "ğŸ·ï¸ Release tag: $RELEASE_TAG"
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          curl \
          parted \
          dosfstools \
          e2fsprogs \
          mtools \
          qemu-user-static \
          binfmt-support \
          fakeroot \
          cpio \
          kmod \
          rsync
          
    - name: Download and extract rootfs image
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "ğŸ“¥ Downloading compressed rootfs image..."
        
        # ä¼˜å…ˆä¸‹è½½zipå‹ç¼©åŒ…
        gh release download $RELEASE_TAG \
          --pattern "root-*$DISTRIBUTION*.zip" \
          --repo ${{ github.repository }} || {
          echo "âš ï¸ Failed to download zip from release, trying img file"
          # å¦‚æœzipä¸å­˜åœ¨ï¼Œä¸‹è½½imgæ–‡ä»¶
          gh release download $RELEASE_TAG \
            --pattern "root-*$DISTRIBUTION*.img" \
            --repo ${{ github.repository }} || {
            echo "âš ï¸ Failed to download rootfs from release, trying artifacts"
            # ä»å·¥ä½œæµäº§ç‰©ä¸‹è½½
            gh run download --name "xiaomi-raphael-rootfs_${DISTRIBUTION}_${KERNEL_VERSION}" || {
              echo "âŒ No rootfs image found"
              exit 1
            }
          }
        }
        
        # å¦‚æœæ˜¯zipæ–‡ä»¶ï¼Œåˆ™è§£å‹
        if ls root-*.zip 1> /dev/null 2>&1; then
          echo "ğŸ—œï¸ Extracting rootfs zip file..."
          ZIP_FILE=$(ls root-*.zip | head -1)
          unzip "$ZIP_FILE"
          echo "âœ… Extracted: $ZIP_FILE"
          # åˆ é™¤zipæ–‡ä»¶ä»¥èŠ‚çœç©ºé—´
          rm "$ZIP_FILE"
        fi
        
        ROOTFS_IMG=$(ls root-*.img | head -1)
        if [ -z "$ROOTFS_IMG" ]; then
          echo "âŒ No rootfs image found after extraction"
          exit 1
        fi
        
        echo "âœ… Rootfs image: $ROOTFS_IMG"
        
    - name: Build boot image using script
      run: |
        echo "ğŸ”§ Building boot image using raphael-boot_build.sh..."
        
        # ç»™è„šæœ¬æ‰§è¡Œæƒé™
        chmod +x raphael-boot_build.sh
        
        # æ‰§è¡Œbooté•œåƒæ„å»ºè„šæœ¬
        ./raphael-boot_build.sh \
          --kernel-version "$KERNEL_VERSION" \
          --distribution "$DISTRIBUTION" \
          --rootfs-image "$ROOTFS_IMG" \
          --output "xiaomi-k20pro-boot-${DISTRIBUTION}-${KERNEL_VERSION}.img"
        
        echo "âœ… Boot image built successfully"
        
    - name: Upload boot image to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: "Boot Image ${{ github.event.inputs.kernel_version }} for Xiaomi Raphael"
        body: |
          # Boot Image ${{ github.event.inputs.kernel_version }} for Xiaomi Raphael
          
          ## Image Details
          - **Distribution**: ${{ github.event.inputs.distribution }}
          - **Kernel Version**: ${{ github.event.inputs.kernel_version }}
          - **RootFS UUID**: ${{ env.ROOTFS_UUID }}
          
          ## Usage
          Flash this boot image to the boot partition of your Xiaomi K20 Pro device.
          
          ## Boot Configuration
          The image contains a properly configured systemd-boot loader with:
          - Linux kernel (linux.efi)
          - Initramfs (initramfs)
          - Root filesystem UUID: ${{ env.ROOTFS_UUID }}
          
        files: xiaomi-k20pro-boot-*.img
        draft: false
        prerelease: false
        
    - name: Upload boot image as artifact
      uses: actions/upload-artifact@v4
      with:
        name: boot-image-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}
        path: xiaomi-k20pro-boot-*.img
        retention-days: 30
        
    - name: Display build summary
      run: |
        echo "ğŸ‰ Boot image creation completed successfully!"
        echo "ğŸ“¦ Distribution: $DISTRIBUTION"
        echo "ğŸ”§ Kernel Version: $KERNEL_VERSION"
        echo "ğŸ”‘ RootFS UUID: ${{ env.ROOTFS_UUID }}"
        echo "ğŸ“¤ Boot image uploaded to GitHub Release: $RELEASE_TAG"