name: Boot Image Creation

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version for boot image (e.g., 6.18)'
        required: true
        type: string
        default: '6.18'
      distribution:
        description: 'Distribution to use (ubuntu/armbian)'
        required: true
        type: string
        default: 'ubuntu'

env:
  KERNEL_VERSION: ${{ github.event.inputs.kernel_version }}
  DISTRIBUTION: ${{ github.event.inputs.distribution }}
  RELEASE_TAG: v${{ github.event.inputs.kernel_version }}

jobs:
  create-boot-image:
    name: Create Boot Image
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        echo "üîß Creating boot image for $DISTRO with kernel $KERNEL_VERSION"
        echo "üè∑Ô∏è Release tag: $RELEASE_TAG"
        
    - name: Cache build components
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache
          ./boot-image-build
          ./rootfs-*.*
        key: ${{ runner.os }}-boot-image-${{ github.event.inputs.kernel_version }}-${{ github.event.inputs.distribution }}-${{ hashFiles('build-config.sh', 'raphael-boot_build.sh') }}
        restore-keys: |
          ${{ runner.os }}-boot-image-${{ github.event.inputs.kernel_version }}-${{ github.event.inputs.distribution }}-
          ${{ runner.os }}-boot-image-${{ github.event.inputs.kernel_version }}-
          ${{ runner.os }}-boot-image-
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          curl \
          parted \
          dosfstools \
          e2fsprogs \
          mtools \
          qemu-user-static \
          binfmt-support \
          fakeroot \
          cpio \
          kmod \
          rsync \
          jq
          
    - name: Download and extract rootfs image
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "üì• Downloading compressed rootfs image..."
        
        # ‰ºòÂÖà‰∏ãËΩΩzipÂéãÁº©ÂåÖ
        gh release download $RELEASE_TAG \
          --pattern "root-*$DISTRIBUTION*.zip" \
          --repo ${{ github.repository }} || {
          echo "‚ö†Ô∏è Failed to download zip from release, trying img file"
          # Â¶ÇÊûúzip‰∏çÂ≠òÂú®Ôºå‰∏ãËΩΩimgÊñá‰ª∂
          gh release download $RELEASE_TAG \
            --pattern "root-*$DISTRIBUTION*.img" \
            --repo ${{ github.repository }} || {
            echo "‚ö†Ô∏è Failed to download rootfs from release, trying artifacts"
            # ‰ªéÂ∑•‰ΩúÊµÅ‰∫ßÁâ©‰∏ãËΩΩ
            gh run download --name "xiaomi-raphael-rootfs_${DISTRIBUTION}_${KERNEL_VERSION}" || {
              echo "‚ùå No rootfs image found"
              exit 1
            }
          }
        }
        
        # Â¶ÇÊûúÊòØzipÊñá‰ª∂ÔºåÂàôËß£Âéã
        if ls root-*.zip 1> /dev/null 2>&1; then
          echo "üóúÔ∏è Extracting rootfs zip file..."
          ZIP_FILE=$(ls root-*.zip | head -1)
          unzip "$ZIP_FILE"
          echo "‚úÖ Extracted: $ZIP_FILE"
          # Âà†Èô§zipÊñá‰ª∂‰ª•ËäÇÁúÅÁ©∫Èó¥
          rm "$ZIP_FILE"
        fi
        
        ROOTFS_IMG=$(ls root-*.img | head -1)
        if [ -z "$ROOTFS_IMG" ]; then
          echo "‚ùå No rootfs image found after extraction"
          exit 1
        fi
        
        echo "‚úÖ Rootfs image: $ROOTFS_IMG"
        
    - name: Build boot image using script
      run: |
        echo "üîß Building boot image using raphael-boot_build.sh..."
        
        # ÁªôËÑöÊú¨ÊâßË°åÊùÉÈôê
        chmod +x raphael-boot_build.sh
        
        # ÊâßË°åbootÈïúÂÉèÊûÑÂª∫ËÑöÊú¨
        ./raphael-boot_build.sh \
          --kernel-version "$KERNEL_VERSION" \
          --distribution "$DISTRIBUTION" \
          --rootfs-image "$ROOTFS_IMG" \
          --output "xiaomi-k20pro-boot-${DISTRIBUTION}-${KERNEL_VERSION}.img"
        
        # Extract ROOTFS_UUID from script output
        if grep -q "ROOTFS_UUID" output/boot/boot-image-info.txt; then
          ROOTFS_UUID=$(grep "ROOTFS_UUID" output/boot/boot-image-info.txt | cut -d'=' -f2)
          echo "ROOTFS_UUID=$ROOTFS_UUID" >> $GITHUB_ENV
        fi
        
        echo "‚úÖ Boot image built successfully"
        
    - name: Verify boot image
      run: |
        echo "üîç Verifying boot image..."
        
        # Check if boot image exists
        BOOT_IMG=$(ls xiaomi-k20pro-boot-*.img 2>/dev/null | head -1)
        if [ -z "$BOOT_IMG" ]; then
          echo "‚ùå Boot image not found"
          exit 1
        fi
        
        echo "‚úÖ Boot image: $BOOT_IMG"
        echo "üìä Boot image details:"
        ls -lh "$BOOT_IMG"
        file "$BOOT_IMG"
        
        # Verify image size (should be around 256MB for boot partition)
        IMG_SIZE=$(stat -c%s "$BOOT_IMG")
        MIN_SIZE=$((200 * 1024 * 1024))  # 200MB
        MAX_SIZE=$((500 * 1024 * 1024))  # 500MB
        if [ "$IMG_SIZE" -ge "$MIN_SIZE" ] && [ "$IMG_SIZE" -le "$MAX_SIZE" ]; then
          echo "‚úÖ Boot image size is within expected range"
        else
          echo "‚ö†Ô∏è Boot image size ($IMG_SIZE bytes) is outside expected range ($MIN_SIZE - $MAX_SIZE bytes)"
        fi
        
        # Try to mount and check content
        echo "üîç Checking boot image content..."
        mkdir -p /tmp/boot-mount
        sudo mount -o loop "$BOOT_IMG" /tmp/boot-mount
        
        # Check essential boot files
        essential_files=("/tmp/boot-mount/EFI/boot/bootaa64.efi" "/tmp/boot-mount/loader/entries/ubuntu.conf" "/tmp/boot-mount/linux.efi" "/tmp/boot-mount/initramfs")
        
        for file in "${essential_files[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ Found: $file"
          else
            echo "‚ùå Missing: $file"
          fi
        done
        
        # Check loader configuration
        if [ -f "/tmp/boot-mount/loader/loader.conf" ]; then
          echo "üìÑ Loader configuration:"
          cat /tmp/boot-mount/loader/loader.conf
        fi
        
        # Check Ubuntu entry
        if [ -f "/tmp/boot-mount/loader/entries/ubuntu.conf" ]; then
          echo "üìÑ Ubuntu boot entry:"
          cat /tmp/boot-mount/loader/entries/ubuntu.conf
          
          # Verify kernel version in entry
          if grep -q "$KERNEL_VERSION" /tmp/boot-mount/loader/entries/ubuntu.conf; then
            echo "‚úÖ Kernel version in boot entry matches: $KERNEL_VERSION"
          else
            echo "‚ö†Ô∏è Kernel version in boot entry does not match"
          fi
        fi
        
        # Unmount
        sudo umount /tmp/boot-mount
        rmdir /tmp/boot-mount
        
        echo "‚úÖ Boot image verification completed"
        
    - name: Upload boot image to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: "Boot Image ${{ github.event.inputs.kernel_version }} for Xiaomi Raphael"
        body: |
          # Boot Image ${{ github.event.inputs.kernel_version }} for Xiaomi Raphael
          
          ## Image Details
          - **Distribution**: ${{ github.event.inputs.distribution }}
          - **Kernel Version**: ${{ github.event.inputs.kernel_version }}
          - **RootFS UUID**: ${{ env.ROOTFS_UUID }}
          - **Build Date**: ${{ github.event.repository.created_at }}
          - **Build ID**: ${{ github.run_id }}
          
          ## Usage
          Flash this boot image to the boot partition of your Xiaomi K20 Pro device.
          
          ## Boot Configuration
          The image contains a properly configured systemd-boot loader with:
          - Linux kernel (linux.efi)
          - Initramfs (initramfs)
          - Root filesystem UUID: ${{ env.ROOTFS_UUID }}
          
          ## Installation Instructions
          ```bash
          # Flash the boot image
          fastboot flash boot xiaomi-k20pro-boot-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}.img
          
          # Reboot
          fastboot reboot
          ```
          
        files: xiaomi-k20pro-boot-*.img
        draft: false
        prerelease: false
        
    - name: Upload boot image as artifact
      uses: actions/upload-artifact@v4
      with:
        name: boot-image-${{ github.event.inputs.distribution }}-${{ github.event.inputs.kernel_version }}
        path: xiaomi-k20pro-boot-*.img
        retention-days: 30
        
    - name: Display build summary
      run: |
        echo "üéâ Boot image creation completed successfully!"
        echo "üì¶ Distribution: $DISTRIBUTION"
        echo "üîß Kernel Version: $KERNEL_VERSION"
        echo "üîë RootFS UUID: ${{ env.ROOTFS_UUID }}"
        echo "üì§ Boot image uploaded to GitHub Release: $RELEASE_TAG"
        echo "üìä Final boot image:"
        ls -lh xiaomi-k20pro-boot-*.img