name: Boot Image Creation

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version for boot image (e.g., 6.18)'
        required: true
        type: string
        default: '6.18'
      distribution:
        description: 'Distribution to use (ubuntu/armbian)'
        required: true
        type: string
        default: 'ubuntu'

env:
  KERNEL_VERSION: ${{ github.event.inputs.kernel_version }}
  DISTRIBUTION: ${{ github.event.inputs.distribution }}
  RELEASE_TAG: v${{ github.event.inputs.kernel_version }}

jobs:
  create-boot-image:
    name: Create Boot Image
    runs-on: ubuntu-24.04-arm
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        echo "ğŸ”§ Creating boot image for $DISTRO with kernel $KERNEL_VERSION"
        echo "ğŸ·ï¸ Release tag: $RELEASE_TAG"
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          curl \
          parted \
          dosfstools \
          e2fsprogs \
          mtools \
          qemu-user-static \
          binfmt-support \
          fakeroot \
          cpio \
          kmod \
          rsync \
          jq
          
    - name: Download rootfs and boot packages
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "ğŸ“¥ Downloading rootfs and boot packages..."
        
        # ä¸‹è½½bootåŒ…ï¼ˆåŒ…å«UUIDã€initrd.imgã€vmlinuzï¼‰
        echo "ğŸ“¦ Downloading boot package..."
        gh release download $RELEASE_TAG \
          --pattern "boot-files-*$DISTRIBUTION*.zip" \
          --repo ${{ github.repository }} || {
          echo "âš ï¸ Failed to download boot package from release, trying artifacts"
          # ä»å·¥ä½œæµäº§ç‰©ä¸‹è½½
          gh run download --name "xiaomi-raphael-rootfs_${DISTRIBUTION}_${KERNEL_VERSION}" || {
            echo "âŒ No boot package found"
            exit 1
          }
        }
        
        # è§£å‹bootåŒ…
        BOOT_PACKAGE=$(ls boot-files-*.zip | head -1)
        if [ -n "$BOOT_PACKAGE" ]; then
          echo "ğŸ—œï¸ Extracting boot package: $BOOT_PACKAGE"
          unzip "$BOOT_PACKAGE"
          echo "âœ… Boot package extracted"
          ls -la boot-files/
          
          # éªŒè¯bootåŒ…æ–‡ä»¶å®Œæ•´æ€§
          echo "ğŸ” Verifying boot package integrity..."
          if [ -f "boot-files/rootfs-uuid.txt" ]; then
            ROOTFS_UUID=$(cat boot-files/rootfs-uuid.txt)
            echo "ROOTFS_UUID=$ROOTFS_UUID" >> $GITHUB_ENV
            echo "âœ… RootFS UUID: $ROOTFS_UUID"
          else
            echo "âŒ RootFS UUID file not found in boot package"
            exit 1
          fi
          
          if [ -f "boot-files/vmlinuz" ]; then
            echo "âœ… vmlinuz file found and accessible"
            file "boot-files/vmlinuz"
            ls -lh "boot-files/vmlinuz"
          else
            echo "âŒ vmlinuz file not found in boot package"
            exit 1
          fi
          
          if [ -f "boot-files/initrd.img" ]; then
            echo "âœ… initrd.img file found and accessible"
            file "boot-files/initrd.img"
            ls -lh "boot-files/initrd.img"
          else
            echo "âŒ initrd.img file not found in boot package"
            exit 1
          fi
          
          echo "âœ… Boot package integrity verified successfully"
        else
          echo "âŒ No boot package found"
          exit 1
        fi
        
        # ä¸‹è½½rootfsé•œåƒï¼ˆç”¨äºéªŒè¯å’Œå‚è€ƒï¼‰
        echo "ğŸ“¥ Downloading rootfs image..."
        gh release download $RELEASE_TAG \
          --pattern "root-*$DISTRIBUTION*.zip" \
          --repo ${{ github.repository }} || {
          echo "âš ï¸ Failed to download zip from release, trying img file"
          # å¦‚æœzipä¸å­˜åœ¨ï¼Œä¸‹è½½imgæ–‡ä»¶
          gh release download $RELEASE_TAG \
            --pattern "root-*$DISTRIBUTION*.img" \
            --repo ${{ github.repository }} || {
            echo "âš ï¸ Failed to download rootfs from release, trying artifacts"
            # ä»å·¥ä½œæµäº§ç‰©ä¸‹è½½
            gh run download --name "xiaomi-raphael-rootfs_${DISTRIBUTION}_${KERNEL_VERSION}" || {
              echo "âŒ No rootfs image found"
              exit 1
            }
          }
        }
        
        # å¦‚æœæ˜¯zipæ–‡ä»¶ï¼Œåˆ™è§£å‹
        if ls root-*.zip 1> /dev/null 2>&1; then
          echo "ğŸ—œï¸ Extracting rootfs zip file..."
          ZIP_FILE=$(ls root-*.zip | head -1)
          unzip "$ZIP_FILE"
          echo "âœ… Extracted: $ZIP_FILE"
          # åˆ é™¤zipæ–‡ä»¶ä»¥èŠ‚çœç©ºé—´
          rm "$ZIP_FILE"
        fi
        
        ROOTFS_IMG=$(ls root-*.img | head -1)
        if [ -z "$ROOTFS_IMG" ]; then
          echo "âš ï¸ No rootfs image found after extraction"
        else
          echo "âœ… Rootfs image: $ROOTFS_IMG"
        fi
        
    - name: Build boot image using script
      run: |
        echo "ğŸ”§ Building boot image using raphael-boot_build.sh..."
        
        # ç»™è„šæœ¬æ‰§è¡Œæƒé™
        chmod +x raphael-boot_build.sh
        
        # æ‰§è¡Œbooté•œåƒæ„å»ºè„šæœ¬
        ./raphael-boot_build.sh \
          --kernel-version "$KERNEL_VERSION" \
          --distribution "$DISTRIBUTION" \
          --rootfs-image "$ROOTFS_IMG" \
          --output "xiaomi-k20pro-boot-${DISTRIBUTION}-${KERNEL_VERSION}.img"
        
        # Extract ROOTFS_UUID from script output
        if grep -q "ROOTFS_UUID" output/boot/boot-image-info.txt; then
          ROOTFS_UUID=$(grep "ROOTFS_UUID" output/boot/boot-image-info.txt | cut -d'=' -f2)
          echo "ROOTFS_UUID=$ROOTFS_UUID" >> $GITHUB_ENV
        fi
        
        echo "âœ… Boot image built successfully"
        
    - name: Verify boot image
      run: |
        echo "ğŸ” Verifying boot image..."
        
        # Check if boot image exists
        BOOT_IMG=$(ls xiaomi-k20pro-boot-*.img 2>/dev/null | head -1)
        if [ -z "$BOOT_IMG" ]; then
          echo "âŒ Boot image not found"
          exit 1
        fi
        
        echo "âœ… Boot image: $BOOT_IMG"
        echo "ğŸ“Š Boot image details:"
        ls -lh "$BOOT_IMG"
        file "$BOOT_IMG"
        
        # Verify image size (should be around 256MB for boot partition)
        IMG_SIZE=$(stat -c%s "$BOOT_IMG")
        MIN_SIZE=$((200 * 1024 * 1024))  # 200MB
        MAX_SIZE=$((500 * 1024 * 1024))  # 500MB
        if [ "$IMG_SIZE" -ge "$MIN_SIZE" ] && [ "$IMG_SIZE" -le "$MAX_SIZE" ]; then
          echo "âœ… Boot image size is within expected range"
        else
          echo "âš ï¸ Boot image size ($IMG_SIZE bytes) is outside expected range ($MIN_SIZE - $MAX_SIZE bytes)"
        fi
        
        # Try to mount and check content
        echo "ğŸ” Checking boot image content..."
        mkdir -p /tmp/boot-mount
        sudo mount -o loop "$BOOT_IMG" /tmp/boot-mount
        
        # Check essential boot files
        essential_files=("/tmp/boot-mount/EFI/boot/bootaa64.efi" "/tmp/boot-mount/loader/entries/ubuntu.conf" "/tmp/boot-mount/linux.efi" "/tmp/boot-mount/initramfs")
        
        for file in "${essential_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… Found: $file"
          else
            echo "âŒ Missing: $file"
          fi
        done
        
        # Check loader configuration
        if [ -f "/tmp/boot-mount/loader/loader.conf" ]; then
          echo "ğŸ“„ Loader configuration:"
          cat /tmp/boot-mount/loader/loader.conf
        fi
        
        # Check Ubuntu entry
        if [ -f "/tmp/boot-mount/loader/entries/ubuntu.conf" ]; then
          echo "ğŸ“„ Ubuntu boot entry:"
          cat /tmp/boot-mount/loader/entries/ubuntu.conf
          
          # Verify kernel version in entry
          if grep -q "$KERNEL_VERSION" /tmp/boot-mount/loader/entries/ubuntu.conf; then
            echo "âœ… Kernel version in boot entry matches: $KERNEL_VERSION"
          else
            echo "âš ï¸ Kernel version in boot entry does not match"
          fi
        fi
        
        # Unmount
        sudo umount /tmp/boot-mount
        rmdir /tmp/boot-mount
        
        echo "âœ… Boot image verification completed"
        
    - name: Upload boot image to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.kernel_version }}
        name: "ğŸš€ å°ç±³ Raphael å¯åŠ¨é•œåƒ ${{ github.event.inputs.kernel_version }} - å®Œæ•´å¯åŠ¨ç¯å¢ƒ"
        body: |
          # ğŸš€ å°ç±³ Raphael (K20 Pro) å¯åŠ¨é•œåƒ ${{ github.event.inputs.kernel_version }}
          
          ## ğŸ·ï¸ å¯åŠ¨é•œåƒä¿¡æ¯
          
          ### ğŸ“Š åŸºæœ¬ä¿¡æ¯
          - **è®¾å¤‡å‹å·**: å°ç±³ Raphael (K20 Pro)
          - **å†…æ ¸ç‰ˆæœ¬**: ${{ github.event.inputs.kernel_version }}
          - **æ¶æ„å¹³å°**: ARM64
          - **ç›®æ ‡å¹³å°**: SM8150 (éªé¾™ 855)
          
          ### ğŸ”§ æ„å»ºè¯¦æƒ…
          - **æ„å»ºæ—¥æœŸ**: ${{ github.event.repository.created_at }}
          - **æ„å»ºID**: ${{ github.run_id }}
          - **å‘å¸ƒæ ‡ç­¾**: v${{ github.event.inputs.kernel_version }}
          
          ## ğŸ—‚ï¸ æ–‡ä»¶è¯´æ˜
          
          ### ğŸ“¸ å¯åŠ¨é•œåƒæ–‡ä»¶
          - **å®Œæ•´å¯åŠ¨é•œåƒ**: xiaomi-k20pro-boot-${{ env.DISTRIBUTION }}-${{ env.KERNEL_VERSION }}.img
          - **åŒ…å«å†…å®¹**: å†…æ ¸ã€è®¾å¤‡æ ‘ã€åˆå§‹åŒ–è„šæœ¬ã€æ ¹æ–‡ä»¶ç³»ç»Ÿ
          - **é•œåƒå¤§å°**: çº¦ 64MB (å‹ç¼©å)
          
          ## ğŸ“‹ ä½¿ç”¨æŒ‡å—
          
          ### âš¡ åˆ·å…¥å¯åŠ¨é•œåƒ
          ```bash
          # è¿›å…¥ fastboot æ¨¡å¼
          adb reboot bootloader
          
          # åˆ·å…¥å¯åŠ¨é•œåƒ
          fastboot flash boot xiaomi-k20pro-boot-${{ env.DISTRIBUTION }}-${{ env.KERNEL_VERSION }}.img
          
          # é‡å¯è®¾å¤‡
          fastboot reboot
          ```
          
          ### ğŸ” éªŒè¯å¯åŠ¨é•œåƒ
          ```bash
          # ä¸´æ—¶å¯åŠ¨æµ‹è¯•
          fastboot boot xiaomi-k20pro-boot-${{ env.DISTRIBUTION }}-${{ env.KERNEL_VERSION }}.img
          
          # æ£€æŸ¥å¯åŠ¨çŠ¶æ€
          adb shell uname -r
          ```
          
          ### ğŸ› ï¸ é«˜çº§ä½¿ç”¨
          ```bash
          # æå–é•œåƒå†…å®¹
          abootimg -x xiaomi-k20pro-boot-${{ env.DISTRIBUTION }}-${{ env.KERNEL_VERSION }}.img
          
          # æŸ¥çœ‹é•œåƒä¿¡æ¯
          file xiaomi-k20pro-boot-${{ env.DISTRIBUTION }}-${{ env.KERNEL_VERSION }}.img
          ```
          
          ## ğŸ¯ è®¾å¤‡å…¼å®¹æ€§
          
          ### âœ… æ”¯æŒè®¾å¤‡
          - å°ç±³ Raphael (K20 Pro)
          - åŸºäº SM8150 å¹³å°çš„è®¾å¤‡
          
          ### ğŸ”§ ç¡¬ä»¶ç‰¹æ€§
          - å®Œæ•´çš„å¯åŠ¨ç¯å¢ƒæ”¯æŒ
          - ä¼˜åŒ–çš„å†…æ ¸å‚æ•°é…ç½®
          - é’ˆå¯¹è®¾å¤‡çš„ç¡¬ä»¶åˆå§‹åŒ–
          - ç¨³å®šçš„å¯åŠ¨æµç¨‹
          
          ## ğŸ“ æ›´æ–°æ—¥å¿—
          
          ### ğŸ”„ ç‰ˆæœ¬æ›´æ–°
          - **å†…æ ¸ç‰ˆæœ¬**: ${{ github.event.inputs.kernel_version }}
          - **å¯åŠ¨ä¼˜åŒ–**: é’ˆå¯¹å°ç±³ Raphael çš„ä¸“é—¨è°ƒä¼˜
          - **æ€§èƒ½æ”¹è¿›**: ä¼˜åŒ–çš„å¯åŠ¨æ—¶é—´å’Œå†…å­˜ç®¡ç†
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - å®Œæ•´çš„ Linux å¯åŠ¨ç¯å¢ƒ
          - é¢„é…ç½®çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ
          - ä¼˜åŒ–çš„ç¡¬ä»¶é©±åŠ¨
          - ç¨³å®šçš„ç³»ç»Ÿåˆå§‹åŒ–
          
          ## â“ å¸¸è§é—®é¢˜
          
          ### Q: å¦‚ä½•éªŒè¯å¯åŠ¨é•œåƒï¼Ÿ
          A: ä½¿ç”¨ `fastboot boot` å‘½ä»¤ä¸´æ—¶å¯åŠ¨ï¼Œæ£€æŸ¥ç³»ç»ŸåŠŸèƒ½ã€‚
          
          ### Q: æ˜¯å¦éœ€è¦è§£é” bootloaderï¼Ÿ
          A: æ˜¯çš„ï¼Œéœ€è¦è§£é”è®¾å¤‡çš„ bootloader æ‰èƒ½åˆ·å…¥ã€‚
          
          ### Q: æ”¯æŒå“ªäº›åŠŸèƒ½ï¼Ÿ
          A: æ”¯æŒå®Œæ•´çš„ Linux ç³»ç»ŸåŠŸèƒ½ï¼ŒåŒ…æ‹¬ç½‘ç»œã€å­˜å‚¨ã€æ˜¾ç¤ºç­‰ã€‚
          
          ### Q: å¦‚ä½•å¤‡ä»½åŸæœ‰é•œåƒï¼Ÿ
          A: åˆ·å…¥å‰å»ºè®®å¤‡ä»½åŸæœ‰å¯åŠ¨é•œåƒï¼š`fastboot boot boot.img backup`
          
          ---
          
          *ğŸ’« ç”± GitHub Actions è‡ªåŠ¨æ„å»ºï¼Œä¸“ä¸ºå°ç±³ Raphael è®¾å¤‡ä¼˜åŒ–*
        files: xiaomi-k20pro-boot-${{ env.DISTRIBUTION }}-${{ env.KERNEL_VERSION }}.img
        draft: false
        prerelease: false
        
    - name: Display build summary
      run: |
        echo "ğŸ‰ Boot image creation completed successfully!"
        echo "ğŸ“¦ Distribution: $DISTRIBUTION"
        echo "ğŸ”§ Kernel Version: $KERNEL_VERSION"
        echo "ğŸ”‘ RootFS UUID: ${{ env.ROOTFS_UUID }}"
        echo "ğŸ“¤ Boot image uploaded to GitHub Release: $RELEASE_TAG"
        echo "ğŸ“Š Final boot image:"
        ls -lh xiaomi-k20pro-boot-*.img